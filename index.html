<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />
  <title>Nossa Jornada | Marcelo & Fernanda</title>

  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Nosso Mundo" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
  <link rel="icon" type="image/png" href="/images/icon-192.png" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --accent-pink: #ff758c;
      --accent-blue: #4facfe;
      --success: #00b09b;
      --danger: #ff5f6d;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      padding-bottom: 90px;
      color: var(--text-color);
      min-height: 100vh;

      background: url('images/fundo.jpg') no-repeat center center fixed;
      background-size: cover;
      background-attachment: fixed;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(3px);
      z-index: -1;
    }

    .header {
      text-align: center;
      margin-bottom: 25px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .header h1 { font-size: 1.8rem; margin: 0; letter-spacing: 1px; }
    .header p { font-size: 0.85rem; opacity: 0.8; font-weight: 300; margin-top: 5px; }

    .btn-agent {
      background: linear-gradient(45deg, #FF9500, #FF5E3A);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      margin-top: 15px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(255, 94, 58, 0.4);
      text-decoration: none;
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      border: var(--glass-border);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    h3 { margin-top: 0; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }

    .level-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer; }
    .xp-track { width: 100%; height: 14px; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; position: relative; }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
      width: 0%;
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(255, 154, 158, 0.7);
    }

    button, .btn-link {
      border: none; outline: none; cursor: pointer;
      font-family: inherit; font-weight: 600;
      transition: transform 0.2s, filter 0.2s;
    }
    button:active { transform: scale(0.96); }

    .btn-main {
      width: 100%; padding: 14px; border-radius: 12px;
      background: var(--primary-gradient);
      color: white; font-size: 1rem;
      box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
    }

    .grid-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .action-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px; padding: 15px;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      color: white; font-size: 0.9rem;
    }
    .act-love { border-color: var(--accent-pink); color: var(--accent-pink); }
    .act-peace { border-color: var(--success); color: var(--success); }
    .act-bad { border-color: var(--danger); color: var(--danger); }

    .finance-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .input-glass {
      flex: 1; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3); color: white; font-family: inherit;
    }
    .btn-deposit { flex: 1; padding: 12px; border-radius: 10px; font-size: 0.9rem; color: #fff; }

    .history-list { max-height: 250px; overflow-y: auto; padding-right: 5px; }
    .history-list::-webkit-scrollbar { width: 4px; }
    .history-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

    .history-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem;
    }
    .badge {
      padding: 3px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase;
      margin-right: 6px;
    }
    .bg-marcelo { background: var(--accent-blue); color: #fff; }
    .bg-fernanda { background: var(--accent-pink); color: #fff; }
    .bg-nos { background: #ffd700; color: #000; }

    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
      display: none; justify-content: center; align-items: center; z-index: 100;
      padding: 20px;
    }
    .modal-box {
      background: #2d3436; border-radius: 20px; padding: 30px; text-align: center;
      border: 2px solid var(--accent-pink); max-width: 350px; animation: popUp 0.4s;
    }
    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .hidden { display: none; }
    .text-gold { color: #ffd700; }
    .text-success { color: var(--success); }
  </style>
</head>

<body>
  <div class="header">
    <h1>Marcelo & Fernanda</h1>
    <p>Construindo nosso 2026 üíç</p>

    <a href="https://conselheirocasal.netlify.app/" target="_blank" class="btn-agent" rel="noopener">
      <i class="fas fa-robot"></i> Conselheiro Virtual
    </a>

    <div id="status-conn" style="font-size: 0.7rem; color: var(--accent-blue); margin-top: 10px;">
      <i class="fas fa-circle-notch fa-spin"></i> Conectando...
    </div>
  </div>

  <div id="modal-premio" class="modal">
    <div class="modal-box">
      <i class="fas fa-trophy fa-3x" style="color: #ffd700; margin-bottom: 15px;"></i>
      <h2 style="color:white; margin-bottom:10px;">N√çVEL NOVO!</h2>
      <p id="premio-txt" style="color:#ccc; margin-bottom:20px; line-height:1.5;">...</p>
      <button class="btn-main" onclick="document.getElementById('modal-premio').style.display='none'">Oba! Vamos nessa!</button>
    </div>
  </div>

  <div class="card" onclick="verProximoPremio()">
    <div class="level-header">
      <h2 id="level-name">Carregando...</h2>
      <span id="xp-total" style="font-weight:bold; color:var(--accent-pink)">0 XP</span>
    </div>
    <div class="xp-track">
      <div class="xp-fill" id="xp-bar"></div>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:0.75rem; color:#aaa;">
      <span>Toque para ver o pr√™mio</span>
      <span>Pr√≥x: <span id="xp-next">100</span></span>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-heart text-gold"></i> Miss√£o do Casal</h3>
    <button class="btn-main" onclick="sortearMissoes()">
      <i class="fas fa-dice"></i> Sortear Desafio
    </button>

    <div id="mission-area" class="hidden" style="margin-top: 15px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
      <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px dashed rgba(255,255,255,0.2)">
        <strong style="color:var(--accent-blue)">MARCELO:</strong>
        <div id="txt-marcelo" style="font-style:italic; margin-top:3px;">...</div>
      </div>
      <div style="margin-bottom: 15px;">
        <strong style="color:var(--accent-pink)">FERNANDA:</strong>
        <div id="txt-fernanda" style="font-style:italic; margin-top:3px;">...</div>
      </div>

      <div style="display:flex; gap:10px;">
        <button class="btn-main" style="background:var(--success)" onclick="completarMissao(true)">Feito! (+20)</button>
        <button class="btn-main" style="background:rgba(255,255,255,0.1); border:1px solid #666" onclick="completarMissao(false)">Falhamos</button>
      </div>
    </div>
  </div>

  <div class="grid-actions" style="margin-bottom: 20px;">
    <button class="action-card act-peace" onclick="registrarAcao(10, 'üïäÔ∏è Dia de Paz')">
      <i class="fas fa-hand-holding-heart fa-2x"></i>
      <span>Dia de Paz</span>
    </button>
    <button class="action-card act-love" onclick="registrarAcao(5, '‚ù§Ô∏è Carinho')">
      <i class="fas fa-kiss-wink-heart fa-2x"></i>
      <span>Carinho</span>
    </button>
    <button class="action-card act-bad" onclick="registrarAcao(-15, 'üò† Briga')">
      <i class="fas fa-angry fa-2x"></i>
      <span>Briga</span>
    </button>
    <button class="action-card" onclick="document.getElementById('camera-input').click()">
      <i class="fas fa-camera fa-2x"></i>
      <span>Foto</span>
    </button>
    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="fotoTirada()" />
  </div>

  <div style="text-align:center; margin-bottom:20px;">
    <a href="https://www.icloud.com/sharedalbum/pt-br/#B1eJtdOXmK81yfe" target="_blank" rel="noopener"
      style="color:#aaa; text-decoration:none; font-size:0.9rem;">
      <i class="fas fa-images"></i> Ver √Ålbum de Fotos
    </a>
  </div>

  <div class="card">
    <h3><i class="fas fa-plane-departure text-gold"></i> Banco 2026</h3>

    <div class="finance-group">
      <select id="user-select" class="input-glass" style="max-width: 110px;">
        <option value="Marcelo">Marcelo</option>
        <option value="Fernanda">Fernanda</option>
        <option value="N√≥s">N√≥s</option>
      </select>
      <input type="text" id="money-input" class="input-glass" placeholder="R$ 0,00" inputmode="decimal" />
    </div>

    <div class="finance-group">
      <button class="btn-deposit" style="background:var(--accent-pink)" onclick="depositar('pe')">Pernambuco</button>
      <button class="btn-deposit" style="background:var(--accent-blue)" onclick="depositar('ch')">Chapada</button>
    </div>

    <div style="margin-top:15px; font-size:0.85rem;">
      <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
        <span>Pernambuco (R$ 2k)</span> <span id="total-pe" class="text-gold">R$ 0,00</span>
      </div>
      <div class="xp-track" style="height:6px;">
        <div class="xp-fill" id="bar-pe" style="background:var(--accent-pink); width:0%"></div>
      </div>

      <div style="display:flex; justify-content:space-between; margin-bottom:5px; margin-top:10px;">
        <span>Chapada (R$ 800)</span> <span id="total-ch" class="text-success">R$ 0,00</span>
      </div>
      <div class="xp-track" style="height:6px;">
        <div class="xp-fill" id="bar-ch" style="background:var(--accent-blue); width:0%"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-bullseye text-gold"></i> Metas 2026</h3>
    <p style="font-size:0.8rem; opacity:0.8; margin-bottom:15px;">O que vamos conquistar individualmente?</p>

    <div class="finance-group">
      <select id="meta-dono" class="input-glass" onchange="renderizarMetas()" style="max-width: 110px;">
        <option value="Marcelo">Marcelo</option>
        <option value="Fernanda">Fernanda</option>
      </select>
      <input type="text" id="meta-texto" class="input-glass" placeholder="Escreva uma meta..." />
      <button class="btn-deposit" style="background:var(--success); flex:0 0 50px;" onclick="adicionarMeta()">
        <i class="fas fa-plus"></i>
      </button>
    </div>

    <div id="lista-metas" class="history-list" style="margin-top:10px; max-height: 200px;">
      <div style="text-align:center; padding:15px; color:#aaa;">Carregando...</div>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-church text-gold"></i> Presen√ßa na Igreja</h3>
    <p style="font-size:0.85rem; opacity:0.8;">
      Registre cada culto de domingo que voc√™s forem juntos.
    </p>

    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
      <div>
        <div id="igreja-total" style="font-size:2rem; font-weight:bold;">0</div>
        <div style="font-size:0.8rem; opacity:0.8;">Domingos registrados</div>
      </div>

      <button class="btn-main"
              style="width:auto; padding:10px 16px; background:linear-gradient(135deg,#22c55e,#16a34a);"
              onclick="marcarIgrejaHoje()">
        <i class="fas fa-check-circle"></i> Marcar hoje
      </button>
    </div>

    <div id="igreja-last" style="margin-top:10px; font-size:0.8rem; opacity:0.8;">
      √öltimo registro: ‚Äî
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h3><i class="fas fa-history"></i> Di√°rio</h3>
      <i class="fas fa-trash" style="color:#666; cursor:pointer;" onclick="limparTudo()" title="Resetar Tudo"></i>
    </div>
    <div id="history-list" class="history-list">
      <div style="text-align:center; padding:20px; color:#aaa;">Carregando hist√≥ria...</div>
    </div>
  </div>

  <script type="module">
    // Service Worker (PWA)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js").catch(() => {});
      });
    }

    const statusEl = document.getElementById("status-conn");

    function setStatus(html, cssColor) {
      statusEl.innerHTML = html;
      statusEl.style.color = cssColor;
    }

    window.addEventListener("offline", () => {
      setStatus('<i class="fas fa-wifi"></i> Offline', "var(--danger)");
    });

    window.addEventListener("online", () => {
      // n√£o assume firebase pronto ‚Äî s√≥ atualiza o texto
      setStatus('<i class="fas fa-circle-notch fa-spin"></i> Reconectando...', "var(--accent-blue)");
    });

    const fmtBRL = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });

    // Estado
    let estado = {
      xp: 0,
      pe: 0,
      ch: 0,
      list: [],
      igrejaCount: 0,
      igrejaLast: null,
      metas: {}
    };

    // DADOS DO JOGO
    const niveis = [
      {id:1, max:100, nome:"In√≠cio", premio:"Piquenique na Ermida Dom Bosco"},
      {id:2, max:300, nome:"Aprendizes", premio:"Caminhada no Pont√£o + √Ågua de Coco"},
      {id:3, max:600, nome:"Parceiros", premio:"Eix√£o do Lazer + Fotos na SQS 308"},
      {id:4, max:1000, nome:"C√∫mplices", premio:"CCBB Cultural + Passeio no Jardim"},
      {id:5, max:1500, nome:"Namorados", premio:"Pastel na Torre de TV"},
      {id:6, max:2200, nome:"Noivos", premio:"Cine Drive-in (Noite Retr√¥)"},
      {id:7, max:3000, nome:"Guardi√µes", premio:"Trilha na √Ågua Mineral"},
      {id:8, max:4000, nome:"Guerreiros", premio:"Visita ao Templo da LBV (Paz)"},
      {id:9, max:5500, nome:"Inabal√°veis", premio:"Jardim Bot√¢nico (Piquenique)"},
      {id:10, max:7000, nome:"Alma G√™mea", premio:"Torre Digital (Vista do DF)"},
      {id:11, max:9000, nome:"Realeza", premio:"Jantar de Gala em Casa"},
      {id:12, max:12000, nome:"Lend√°rios", premio:"VIAGEM PARA PERNAMBUCO!"}
    ];

    const missoes = [
      "Orem juntos agradecendo por tr√™s coisas espec√≠ficas que aconteceram hoje.",
      "Leiam um trecho de Prov√©rbios e conversem 5 minutos sobre o que mais chamou aten√ß√£o.",
      "Fa√ßam uma ora√ß√£o um pelo outro, cada um pedindo algo especial para a vida do outro.",
      "Escolham um vers√≠culo para ser o ‚Äòvers√≠culo do dia‚Äô e deixem anotado em algum lugar vis√≠vel.",
      "Ou√ßam um hino ou louvor juntos e depois conversem sobre o que essa m√∫sica j√° significou para voc√™s.",
      "Fa√ßam uma ora√ß√£o s√≥ de gratid√£o, sem pedir nada, por pelo menos dois minutos.",
      "Cada um escreva uma breve ora√ß√£o pelo outro em um papel e depois leiam em voz alta.",
      "Conversem sobre uma situa√ß√£o dif√≠cil em que sentiram que Deus cuidou de voc√™s como casal.",
      "Leiam juntos um salmo de prote√ß√£o e fa√ßam uma ora√ß√£o pela fam√≠lia.",
      "Escolham um casal amigo ou parente e orem rapidamente por eles juntos.",
      "D√™em um beijo longo e sem pressa, olhando nos olhos antes de encostar os l√°bios.",
      "Fa√ßam um abra√ßo demorado de pelo menos 30 segundos em sil√™ncio.",
      "Cada um diga em voz alta tr√™s qualidades que mais admira no outro.",
      "Preparem juntos um lanche simples √† noite e comam abra√ßados no sof√°.",
      "Escolham uma m√∫sica rom√¢ntica e dancem um trecho dela na sala de casa.",
      "Tirem uma selfie abra√ßados para registrar o dia de hoje e guardem em um √°lbum de voc√™s.",
      "Surpreenda o outro com um toque de carinho inesperado (um cafun√©, um abra√ßo por tr√°s, etc.).",
      "Escrevam uma frase rom√¢ntica em um bilhetinho e escondam para o outro encontrar depois.",
      "Fa√ßam uma ‚Äòcompeti√ß√£o de elogios‚Äô: cada um faz tr√™s elogios diferentes para o outro.",
      "Segurem as m√£os por alguns minutos enquanto conversam sobre algo do dia.",
      "Pergunte ao outro: ‚ÄòComo voc√™ est√° de verdade hoje?‚Äô e ou√ßa sem interromper.",
      "Cada um compartilhe uma preocupa√ß√£o atual e o outro apenas ouve, sem tentar resolver.",
      "Conversem sobre uma pequena m√°goa recente e tentem limpar isso com carinho.",
      "Fa√ßam o exerc√≠cio de dizer: ‚ÄòEu me sinto‚Ä¶ quando‚Ä¶‚Äô para algo que incomoda, sem acusar.",
      "Pense em algo que voc√™ poderia ter feito melhor esta semana e pe√ßa perd√£o se for necess√°rio.",
      "Cada um conte um sonho pessoal que ainda n√£o explicou com detalhes para o outro.",
      "Conversem sobre um conflito antigo que j√° foi superado e celebrem juntos a vit√≥ria.",
      "Escolham uma frase para ser o ‚Äòmantra de paz‚Äô de voc√™s quando come√ßarem a discutir.",
      "Fa√ßam um combinado de como querem resolver brigas daqui pra frente (tom, hor√°rio, lugar).",
      "Cada um diga uma coisa que gostaria de melhorar em si mesmo para ser um parceiro melhor.",
      "Escolham uma tarefa da casa para fazerem juntos hoje, em vez de fazer separados.",
      "Organizem uma pequena gaveta ou canto bagun√ßado da casa trabalhando em dupla.",
      "Preparem o caf√© da manh√£ ou um caf√© da tarde simples juntos, dividindo as fun√ß√µes.",
      "Fa√ßam uma pequena faxina de 15 minutos ouvindo m√∫sica e trabalhando como time.",
      "Planejem a rotina de amanh√£ para diminuir o estresse do dia seguinte.",
      "Montem juntos uma lista de compras r√°pida com coisas que est√£o faltando em casa.",
      "Tirem 10 minutos para arrumar a cama e o quarto de forma mais caprichada que o normal.",
      "Definam uma pequena meta dom√©stica da semana (por exemplo: organizar um arm√°rio).",
      "Revejam juntos uma conta ou gasto da casa para entender melhor o or√ßamento.",
      "Combinem uma tarefa que um vai aliviar do outro esta semana (ex: lou√ßa, lixo, etc.).",
      "Relembrem uma hist√≥ria engra√ßada que j√° viveram juntos e tentem contar em detalhes.",
      "Escolham um v√≠deo engra√ßado para assistir juntos e deem risada sem pressa.",
      "Joguem um joguinho r√°pido (baralho, jogo de perguntas, adivinha√ß√£o, etc.).",
      "Fa√ßam um desenho bobo um do outro e mostrem ao final, sem julgamento.",
      "Invente um apelido carinhoso novo para o outro s√≥ para este dia.",
      "Escolham um filme ou s√©rie para ver pelo menos 20 minutos juntinhos.",
      "Criem uma ‚Äòpiada interna‚Äô nova hoje, algo que s√≥ voc√™s dois entendam.",
      "Montem uma mini lista de coisas diferentes que gostariam de fazer no pr√≥ximo m√™s.",
      "Cada um conte uma lembran√ßa da inf√¢ncia que o outro ainda n√£o conhece.",
      "Finjam que est√£o em um ‚Äòprimeiro encontro‚Äô e conversem como se estivessem se conhecendo hoje.",
      "Conversem por 10 minutos sobre um objetivo financeiro que querem alcan√ßar juntos.",
      "Atualizem mentalmente ou no papel quanto j√° avan√ßaram nas metas de viagem.",
      "Cada um diga uma meta pessoal para os pr√≥ximos 7 dias e pe√ßa ao outro para cobrar com carinho.",
      "Listem tr√™s coisas que querem muito viver juntos nos pr√≥ximos dois anos.",
      "Falem sobre como imaginam a rotina de voc√™s daqui a cinco anos.",
      "Conversem sobre um h√°bito ruim financeiro que gostariam de melhorar.",
      "Escrevam uma pequena meta de casal para este m√™s e deixem anotada.",
      "Escolham um ‚Äòpresente de futuro‚Äô (algo que querem comprar/juntar dinheiro) e combinem um plano.",
      "Planejem rapidamente um ‚Äòencontro simples‚Äô para a pr√≥xima semana (em casa ou fora).",
      "Terminem o dia agradecendo em voz alta por algo que o outro fez hoje, mesmo que pequeno."
    ];

    // Firebase (carregamento robusto)
    let firebaseReady = false;
    let db = null, dbRef = null, igrejaRef = null;
    let fbRef = null, fbPush = null, fbOnValue = null, fbRemove = null;

    function requireFirebase() {
      if (!firebaseReady) {
        alert("Sem conex√£o/servi√ßo no momento. Tente novamente quando estiver online.");
        throw new Error("Firebase not ready");
      }
    }

    function parseMoneyBR(raw) {
      const cleaned = String(raw || "")
        .replace(/\s/g, "")
        .replace("R$", "")
        .replace(/\./g, "")
        .replace(",", ".");
      const val = Number.parseFloat(cleaned);
      return Number.isFinite(val) ? val : 0;
    }

    function recalcular() {
      estado.xp = 0; estado.pe = 0; estado.ch = 0;
      estado.list.forEach(i => {
        estado.xp += Number(i.xp || 0);
        if (i.tipo === "pe") estado.pe += Number(i.val || 0);
        if (i.tipo === "ch") estado.ch += Number(i.val || 0);
      });
    }

    function getNivel() {
      let atual = niveis[0];
      for (let n of niveis) {
        if (estado.xp < n.max) { atual = n; break; }
        if (n.id === 12) atual = n;
      }
      return atual;
    }

    function renderizar() {
      // N√≠vel
      const n = getNivel();
      document.getElementById("level-name").innerText = n.nome;
      document.getElementById("xp-total").innerText = `${estado.xp} XP`;
      document.getElementById("xp-next").innerText = n.max;

      const perc = Math.min((estado.xp / n.max) * 100, 100);
      document.getElementById("xp-bar").style.width = `${perc}%`;

      // Financeiro
      document.getElementById("total-pe").innerText = fmtBRL.format(estado.pe);
      document.getElementById("bar-pe").style.width = `${Math.min((estado.pe / 2000) * 100, 100)}%`;

      document.getElementById("total-ch").innerText = fmtBRL.format(estado.ch);
      document.getElementById("bar-ch").style.width = `${Math.min((estado.ch / 800) * 100, 100)}%`;

      // Hist√≥rico
      const lista = document.getElementById("history-list");
      lista.innerHTML = "";

      [...estado.list].reverse().forEach(i => {
        const who = i.user || "N√≥s";
        const cls = who === "Marcelo" ? "bg-marcelo" : (who === "Fernanda" ? "bg-fernanda" : "bg-nos");
        const xpNum = Number(i.xp || 0);
        const xpColor = xpNum > 0 ? "var(--success)" : (xpNum < 0 ? "var(--danger)" : "#aaa");
        const valNum = Number(i.val || 0);
        const valTxt = valNum > 0 ? `(${fmtBRL.format(valNum)})` : "";
        const dateTxt = i.date || "";

        lista.innerHTML += `
          <div class="history-item">
            <div>
              <div>
                <span class="badge ${cls}">${who}</span>
                <span style="opacity:0.6; font-size:0.7rem">${dateTxt}</span>
              </div>
              <div style="margin-top:4px;">${i.desc || ""} ${valTxt}</div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              <span style="color:${xpColor}; font-weight:bold;">${xpNum > 0 ? "+" : ""}${xpNum}</span>
              ${firebaseReady ? `<i class="fas fa-times" style="opacity:0.3; cursor:pointer;" onclick="remover('${i.id}')"></i>` : ``}
            </div>
          </div>
        `;
      });

      if (!estado.list.length) {
        lista.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa;">Sem registros ainda.</div>`;
      }

      // Presen√ßa na Igreja
      const igrejaTotalEl = document.getElementById("igreja-total");
      const igrejaLastEl = document.getElementById("igreja-last");

      if (igrejaTotalEl) {
        igrejaTotalEl.innerText = estado.igrejaCount || 0;
      }

      if (igrejaLastEl) {
        if (estado.igrejaLast) {
          igrejaLastEl.innerText = `√öltimo registro: ${estado.igrejaLast.date || "‚Äî"}`;
        } else {
          igrejaLastEl.innerText = "√öltimo registro: ‚Äî";
        }
      }
    }

    // --- FUN√á√ïES DE METAS ---
    
    window.renderizarMetas = () => {
      const dono = document.getElementById("meta-dono").value;
      const listaEl = document.getElementById("lista-metas");
      if (!listaEl) return;
      listaEl.innerHTML = "";

      const dados = estado.metas && estado.metas[dono] ? estado.metas[dono] : {};
      const chaves = Object.keys(dados);

      if (chaves.length === 0) {
        listaEl.innerHTML = `<div style="text-align:center; padding:15px; opacity:0.6;">Nenhuma meta definida ainda. Bora sonhar?</div>`;
        return;
      }

      chaves.forEach(key => {
        const item = dados[key];
        listaEl.innerHTML += `
          <div class="history-item">
            <div style="flex:1; padding-right:10px;">
              <i class="fas fa-star" style="color:#ffd700; font-size:0.7rem; margin-right:5px;"></i>
              ${item.texto}
            </div>
            <i class="fas fa-trash" style="color:var(--danger); opacity:0.6; cursor:pointer;" onclick="apagarMeta('${dono}', '${key}')"></i>
          </div>
        `;
      });
    };

    window.adicionarMeta = () => {
      requireFirebase();
      const dono = document.getElementById("meta-dono").value;
      const input = document.getElementById("meta-texto");
      const texto = input.value.trim();

      if (!texto) return alert("Escreva alguma coisa!");

      fbPush(ref(db, `metas/${dono}`), {
        texto: texto,
        criadoEm: new Date().toLocaleDateString()
      });

      input.value = ""; 
    };

    window.apagarMeta = (dono, id) => {
      requireFirebase();
      if(confirm("J√° completou ou quer desistir dessa meta?")) {
        fbRemove(ref(db, `metas/${dono}/${id}`));
      }
    };

    // Fun√ß√µes globais (UI)
    window.verProximoPremio = () => {
      const n = getNivel();
      document.getElementById("premio-txt").innerText = n.premio;
      document.getElementById("modal-premio").style.display = "flex";
    };

    window.sortearMissoes = () => {
      const r1 = missoes[Math.floor(Math.random() * missoes.length)];
      const r2 = missoes[Math.floor(Math.random() * missoes.length)];
      document.getElementById("txt-marcelo").innerText = r1;
      document.getElementById("txt-fernanda").innerText = r2;
      document.getElementById("mission-area").classList.remove("hidden");
    };

    window.completarMissao = (sucesso) => {
      if (sucesso) window.registrarAcao(20, "Miss√£o Dupla Cumprida!");
      else window.registrarAcao(-10, "Miss√£o Falhou");
      document.getElementById("mission-area").classList.add("hidden");
    };

    window.fotoTirada = () => {
      alert("Foto tirada! Agora abra o √Ålbum (link abaixo) e adicione ela l√°.");
    };

    // Firebase actions (com seguran√ßa)
    window.registrarAcao = (xp, desc) => {
      requireFirebase();
      const user = document.getElementById("user-select").value || "N√≥s";
      fbPush(dbRef, {
        date: new Date().toLocaleDateString(),
        user,
        desc,
        xp: Number(xp || 0),
        val: 0,
        tipo: null
      });
    };

    window.depositar = (tipo) => {
      requireFirebase();
      const user = document.getElementById("user-select").value || "N√≥s";
      const raw = document.getElementById("money-input").value;
      const val = parseMoneyBR(raw);
      if (!val) return alert("Digite um valor!");

      const desc = tipo === "pe" ? "Poupan√ßa PE" : "Poupan√ßa Chapada";
      fbPush(dbRef, {
        date: new Date().toLocaleDateString(),
        user,
        desc,
        xp: 5,
        val,
        tipo
      });

      document.getElementById("money-input").value = "";
      alert("Dinheiro guardado! üí∏");
    };

    window.remover = (id) => {
      requireFirebase();
      if (confirm("Apagar?")) fbRemove(fbRef(db, `historico/${id}`));
    };

    window.limparTudo = () => {
      requireFirebase();
      if (confirm("Resetar TUDO (XP + Banco + Di√°rio)?")) {
        fbRemove(dbRef);
      }
    };

    // NOVA FUN√á√ÉO: marcar presen√ßa na igreja
    window.marcarIgrejaHoje = () => {
      requireFirebase();

      const hoje = new Date();
      const date = hoje.toLocaleDateString();
      const iso = hoje.toISOString();

      if (estado.igrejaLast && estado.igrejaLast.date === date) {
        const confirma = confirm("J√° tem presen√ßa registrada para hoje. Deseja marcar de novo mesmo assim?");
        if (!confirma) return;
      }

      // 1) Registra na cole√ß√£o espec√≠fica de igreja
      fbPush(igrejaRef, {
        date,
        dateISO: iso,
        obs: "Culto de domingo",
        xp: 20
      });

      // 2) Tamb√©m registra no hist√≥rico geral (ganha XP)
      fbPush(dbRef, {
        date,
        user: "N√≥s",
        desc: "Fomos √† igreja hoje üôè",
        xp: 20,
        val: 0,
        tipo: "igreja"
      });

      alert("Presen√ßa na igreja registrada! Deus aben√ßoe voc√™s üôè");
    };

    // Inicializa√ß√£o (Firebase via import din√¢mico)
    (async () => {
      try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
        const { getDatabase, ref, push, onValue, remove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");

        // SUAS CHAVES DO FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyC8YA9o9KVlKW1j9Ps2gqwYYWJDnFt6Go4",
          authDomain: "casal2026-888ce.firebaseapp.com",
          databaseURL: "https://casal2026-888ce-default-rtdb.firebaseio.com",
          projectId: "casal2026-888ce",
          storageBucket: "casal2026-888ce.firebasestorage.app",
          messagingSenderId: "314398386836",
          appId: "1:314398386836:web:e401b22d85e7bbe5e9e281",
          measurementId: "G-RHXB26B178"
        };

        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        
        dbRef = ref(db, "historico");
        igrejaRef = ref(db, "igreja");
        const metasRef = ref(db, "metas");

        // binds
        fbRef = ref;
        fbPush = push;
        fbOnValue = onValue;
        fbRemove = remove;

        firebaseReady = true;
        setStatus('<i class="fas fa-wifi"></i> Online', "var(--success)");

        fbOnValue(dbRef, (snap) => {
          const data = snap.val();
          estado.list = [];
          if (data) {
            Object.keys(data).forEach(k => estado.list.push({ id: k, ...data[k] }));
          }
          recalcular();
          renderizar();
        });

        fbOnValue(igrejaRef, (snap) => {
          const data = snap.val();
          let count = 0;
          let last = null;

          if (data) {
            Object.keys(data).forEach((k) => {
              const item = data[k];
              count++;
              if (
                !last ||
                new Date(item.dateISO || item.date) >
                  new Date(last?.dateISO || last?.date || 0)
              ) {
                last = item;
              }
            });
          }

          estado.igrejaCount = count;
          estado.igrejaLast = last;
          renderizar();
        });

        // LISTENER DAS METAS
        fbOnValue(metasRef, (snap) => {
          estado.metas = snap.val() || {};
          renderizarMetas();
        });

        // render inicial caso esteja vazio
        renderizar();

      } catch (err) {
        console.error(err);
        setStatus('<i class="fas fa-wifi"></i> Offline', "var(--danger)");
        // ainda renderiza a UI sem quebrar
        renderizar();
      }
    })();
  </script>
</body>
</html>