<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />
  <title>Nossa Jornada | Marcelo & Fernanda</title>

  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Nosso Mundo" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
  <link rel="icon" type="image/png" href="/images/icon-192.png" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --accent-pink: #ff758c;
      --accent-blue: #4facfe;
      --success: #00b09b;
      --danger: #ff5f6d;
      --gold: #ffd700;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      padding-bottom: 90px;
      color: var(--text-color);
      min-height: 100vh;

      background: url('images/fundo.jpg') no-repeat center center fixed;
      background-size: cover;
      background-attachment: fixed;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(3px);
      z-index: -1;
    }

    .header {
      text-align: center;
      margin-bottom: 25px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .header h1 { font-size: 1.8rem; margin: 0; letter-spacing: 1px; }
    .header p { font-size: 0.85rem; opacity: 0.8; font-weight: 300; margin-top: 5px; }

    .btn-agent {
      background: linear-gradient(45deg, #FF9500, #FF5E3A);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      margin-top: 15px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(255, 94, 58, 0.4);
      text-decoration: none;
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      border: var(--glass-border);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      transition: transform 0.2s;
    }
    
    h3 { margin-top: 0; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }

    /* XP BAR */
    .level-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer; }
    .xp-track { width: 100%; height: 14px; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; position: relative; }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
      width: 0%;
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(255, 154, 158, 0.7);
    }

    /* TRAVEL TRACKER STYLES */
    .travel-track-container {
      margin-top: 15px;
      position: relative;
      padding-top: 20px; /* Space for the floating icon */
    }
    .travel-track {
      width: 100%; height: 10px;
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      position: relative;
    }
    .travel-fill {
      height: 100%;
      border-radius: 10px;
      width: 0%;
      transition: width 1.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      position: relative;
    }
    /* O √≠cone flutuante (Avi√£o/Carro) */
    .travel-icon {
      position: absolute;
      right: -12px;
      top: -24px;
      font-size: 1.2rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
      transition: right 1.5s;
    }
    .travel-stats {
      display: flex; justify-content: space-between; font-size: 0.75rem; color: #ccc; margin-top: 6px;
    }

    button { border: none; outline: none; cursor: pointer; font-family: inherit; font-weight: 600; transition: transform 0.2s; }
    button:active { transform: scale(0.96); }

    .btn-main {
      width: 100%; padding: 14px; border-radius: 12px;
      background: var(--primary-gradient);
      color: white; font-size: 1rem;
      box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
    }

    .grid-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .action-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px; padding: 15px;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      color: white; font-size: 0.9rem;
    }
    .act-love { border-color: var(--accent-pink); color: var(--accent-pink); }
    .act-peace { border-color: var(--success); color: var(--success); }
    .act-bad { border-color: var(--danger); color: var(--danger); }

    .finance-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .input-glass {
      flex: 1; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3); color: white; font-family: inherit;
    }
    .input-glass option { background: #333; color: white; }

    .btn-deposit { flex: 1; padding: 12px; border-radius: 10px; font-size: 0.9rem; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

    .history-list { max-height: 250px; overflow-y: auto; padding-right: 5px; }
    .history-list::-webkit-scrollbar { width: 4px; }
    .history-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

    .history-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem;
    }
    .badge {
      padding: 3px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase;
      margin-right: 6px;
    }
    .bg-marcelo { background: var(--accent-blue); color: #fff; }
    .bg-fernanda { background: var(--accent-pink); color: #fff; }
    .bg-nos { background: #ffd700; color: #000; }

    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
      display: none; justify-content: center; align-items: center; z-index: 100;
      padding: 20px;
    }
    .modal-box {
      background: #2d3436; border-radius: 20px; padding: 30px; text-align: center;
      border: 2px solid var(--accent-pink); max-width: 350px; animation: popUp 0.4s;
    }
    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .hidden { display: none; }
    .text-gold { color: #ffd700; }
    .text-success { color: var(--success); }
    
    .status-pill {
      background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; 
      font-size: 0.7rem; display: inline-flex; align-items: center; gap: 5px;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>Marcelo & Fernanda</h1>
    <p>Construindo nosso 2026 üíç</p>

    <a href="https://conselheirocasal.netlify.app/" target="_blank" class="btn-agent" rel="noopener">
      <i class="fas fa-robot"></i> Conselheiro Virtual
    </a>

    <div id="status-conn" style="font-size: 0.7rem; color: var(--accent-blue); margin-top: 10px;">
      <i class="fas fa-circle-notch fa-spin"></i> Conectando...
    </div>
  </div>

  <div id="modal-premio" class="modal">
    <div class="modal-box">
      <i class="fas fa-trophy fa-3x" style="color: #ffd700; margin-bottom: 15px;"></i>
      <h2 style="color:white; margin-bottom:10px;">N√çVEL NOVO!</h2>
      <p id="premio-txt" style="color:#ccc; margin-bottom:20px; line-height:1.5;">...</p>
      <button class="btn-main" onclick="document.getElementById('modal-premio').style.display='none'">Oba! Vamos nessa!</button>
    </div>
  </div>

  <div class="card" onclick="verProximoPremio()">
    <div class="level-header">
      <h2 id="level-name">Carregando...</h2>
      <span id="xp-total" style="font-weight:bold; color:var(--accent-pink)">0 XP</span>
    </div>
    <div class="xp-track">
      <div class="xp-fill" id="xp-bar"></div>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:0.75rem; color:#aaa;">
      <span>Toque para ver o pr√™mio</span>
      <span>Pr√≥x: <span id="xp-next">100</span></span>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-heart text-gold"></i> Miss√£o do Casal</h3>
    <button class="btn-main" onclick="sortearMissoes()">
      <i class="fas fa-dice"></i> Sortear Desafio
    </button>

    <div id="mission-area" class="hidden" style="margin-top: 15px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
      <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px dashed rgba(255,255,255,0.2)">
        <strong style="color:var(--accent-blue)">MARCELO:</strong>
        <div id="txt-marcelo" style="font-style:italic; margin-top:3px;">...</div>
      </div>
      <div style="margin-bottom: 15px;">
        <strong style="color:var(--accent-pink)">FERNANDA:</strong>
        <div id="txt-fernanda" style="font-style:italic; margin-top:3px;">...</div>
      </div>

      <div style="display:flex; gap:10px;">
        <button class="btn-main" style="background:var(--success)" onclick="completarMissao(true)">Feito! (+20)</button>
        <button class="btn-main" style="background:rgba(255,255,255,0.1); border:1px solid #666" onclick="completarMissao(false)">Falhamos</button>
      </div>
    </div>
  </div>

  <div class="grid-actions" style="margin-bottom: 20px;">
    <button class="action-card act-peace" onclick="registrarAcao(10, 'üïäÔ∏è Dia de Paz')">
      <i class="fas fa-hand-holding-heart fa-2x"></i>
      <span>Dia de Paz</span>
    </button>
    <button class="action-card act-love" onclick="registrarAcao(5, '‚ù§Ô∏è Carinho')">
      <i class="fas fa-kiss-wink-heart fa-2x"></i>
      <span>Carinho</span>
    </button>
    <button class="action-card act-bad" onclick="registrarAcao(-15, 'üò† Briga')">
      <i class="fas fa-angry fa-2x"></i>
      <span>Briga</span>
    </button>
    <button class="action-card" onclick="document.getElementById('camera-input').click()">
      <i class="fas fa-camera fa-2x"></i>
      <span>Foto</span>
    </button>
    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="fotoTirada()" />
  </div>

  <div style="text-align:center; margin-bottom:20px;">
    <a href="https://www.icloud.com/sharedalbum/pt-br/#B1eJtdOXmK81yfe" target="_blank" rel="noopener"
      style="color:#aaa; text-decoration:none; font-size:0.9rem;">
      <i class="fas fa-images"></i> Ver √Ålbum de Fotos
    </a>
  </div>

  <div class="card">
    <h3><i class="fas fa-plane-departure text-gold"></i> Banco de Viagens</h3>
    <p style="font-size:0.8rem; opacity:0.7; margin-bottom:15px;">Foco em Novembro/2026 üöÄ</p>

    <div class="finance-group">
      <select id="user-select" class="input-glass" style="max-width: 110px;">
        <option value="Marcelo">Marcelo</option>
        <option value="Fernanda">Fernanda</option>
        <option value="N√≥s">N√≥s</option>
      </select>
      <input type="text" id="money-input" class="input-glass" placeholder="R$ 0,00" inputmode="decimal" />
    </div>

    <div class="finance-group">
      <button class="btn-deposit" style="background:var(--accent-pink)" onclick="depositar('pe')">Recife/PE</button>
      <button class="btn-deposit" style="background:var(--accent-blue)" onclick="depositar('ch')">Chapada</button>
    </div>

    <div style="margin-top:25px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; color:var(--accent-pink)">Pernambuco ‚òÄÔ∏è</span>
        <span id="status-pe" class="status-pill">üéí Iniciando</span>
      </div>
      
      <div class="travel-track-container">
        <div class="travel-track">
          <div class="travel-fill" id="bar-pe" style="background:var(--accent-pink);">
             <i class="fas fa-plane travel-icon" style="color:var(--accent-pink)"></i>
          </div>
        </div>
      </div>
      
      <div class="travel-stats">
        <span id="total-pe">R$ 0,00</span>
        <span>Meta: R$ 7.200</span>
      </div>
    </div>

    <div style="margin-top:25px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; color:var(--accent-blue)">Chapada üèûÔ∏è</span>
        <span id="status-ch" class="status-pill">üéí Iniciando</span>
      </div>
      
      <div class="travel-track-container">
        <div class="travel-track">
          <div class="travel-fill" id="bar-ch" style="background:var(--accent-blue);">
             <i class="fas fa-car-side travel-icon" style="color:var(--accent-blue)"></i>
          </div>
        </div>
      </div>
      
      <div class="travel-stats">
        <span id="total-ch">R$ 0,00</span>
        <span>Meta: R$ 2.500</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-bullseye text-gold"></i> Metas 2026</h3>
    <p style="font-size:0.8rem; opacity:0.8; margin-bottom:15px;">O que vamos conquistar individualmente?</p>

    <div class="finance-group">
      <select id="meta-dono" class="input-glass" onchange="renderizarMetas()" style="max-width: 130px;">
        <option value="" disabled selected>Quem √© voc√™?</option>
        <option value="Marcelo">Marcelo</option>
        <option value="Fernanda">Fernanda</option>
      </select>
      <input type="text" id="meta-texto" class="input-glass" placeholder="Escreva uma meta..." />
      <button class="btn-deposit" style="background:var(--success); flex:0 0 50px;" onclick="adicionarMeta()">
        <i class="fas fa-plus"></i>
      </button>
    </div>

    <div id="lista-metas" class="history-list" style="margin-top:10px; max-height: 200px;">
      <div style="text-align:center; padding:15px; color:#aaa; font-size:0.8rem;">Selecione seu nome acima para ver as metas.</div>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-church text-gold"></i> Presen√ßa na Igreja</h3>
    <p style="font-size:0.85rem; opacity:0.8;">
      Registre cada culto de domingo que voc√™s forem juntos.
    </p>

    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
      <div>
        <div id="igreja-total" style="font-size:2rem; font-weight:bold;">0</div>
        <div style="font-size:0.8rem; opacity:0.8;">Domingos registrados</div>
      </div>

      <button class="btn-main"
              style="width:auto; padding:10px 16px; background:linear-gradient(135deg,#22c55e,#16a34a);"
              onclick="marcarIgrejaHoje()">
        <i class="fas fa-check-circle"></i> Marcar hoje
      </button>
    </div>

    <div id="igreja-last" style="margin-top:10px; font-size:0.8rem; opacity:0.8;">
      √öltimo registro: ‚Äî
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h3><i class="fas fa-history"></i> Di√°rio</h3>
      <i class="fas fa-trash" style="color:#666; cursor:pointer;" onclick="limparTudo()" title="Resetar Tudo"></i>
    </div>
    <div id="history-list" class="history-list">
      <div style="text-align:center; padding:20px; color:#aaa;">Carregando hist√≥ria...</div>
    </div>
  </div>

  <script type="module">
    // Service Worker (PWA)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js").catch(() => {});
      });
    }

    const statusEl = document.getElementById("status-conn");

    function setStatus(html, cssColor) {
      statusEl.innerHTML = html;
      statusEl.style.color = cssColor;
    }

    window.addEventListener("offline", () => { setStatus('<i class="fas fa-wifi"></i> Offline', "var(--danger)"); });
    window.addEventListener("online", () => { setStatus('<i class="fas fa-circle-notch fa-spin"></i> Reconectando...', "var(--accent-blue)"); });

    const fmtBRL = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });

    // Estado
    let estado = {
      xp: 0,
      pe: 0,
      ch: 0,
      list: [],
      igrejaCount: 0,
      igrejaLast: null,
      metas: {}
    };

    // TETOS FINANCEIROS ATUALIZADOS 2026
    const ALVO_PE = 7200; // Recife
    const ALVO_CH = 2500; // Chapada

    // DADOS DO JOGO
    const niveis = [
      {id:1, max:100, nome:"In√≠cio", premio:"Piquenique na Ermida Dom Bosco"},
      {id:2, max:300, nome:"Aprendizes", premio:"Caminhada no Pont√£o + √Ågua de Coco"},
      {id:3, max:600, nome:"Parceiros", premio:"Eix√£o do Lazer + Fotos na SQS 308"},
      {id:4, max:1000, nome:"C√∫mplices", premio:"CCBB Cultural + Passeio no Jardim"},
      {id:5, max:1500, nome:"Namorados", premio:"Pastel na Torre de TV"},
      {id:6, max:2200, nome:"Noivos", premio:"Cine Drive-in (Noite Retr√¥)"},
      {id:7, max:3000, nome:"Guardi√µes", premio:"Trilha na √Ågua Mineral"},
      {id:8, max:4000, nome:"Guerreiros", premio:"Visita ao Templo da LBV (Paz)"},
      {id:9, max:5500, nome:"Inabal√°veis", premio:"Jardim Bot√¢nico (Piquenique)"},
      {id:10, max:7000, nome:"Alma G√™mea", premio:"Torre Digital (Vista do DF)"},
      {id:11, max:9000, nome:"Realeza", premio:"Jantar de Gala em Casa"},
      {id:12, max:12000, nome:"Lend√°rios", premio:"VIAGEM PARA PERNAMBUCO!"}
    ];

    const missoes = [
      // --- ESPIRITUALIDADE & F√â ---
      "Orem juntos agradecendo por tr√™s coisas espec√≠ficas que aconteceram hoje.",
      "Leiam Prov√©rbios 31 ou Salmos 23 juntos e comentem um vers√≠culo.",
      "Fa√ßam uma ora√ß√£o de m√£os dadas intercedendo pela fam√≠lia um do outro.",
      "Escolham um louvor que marque a hist√≥ria de voc√™s e ou√ßam abra√ßados.",
      "Compartilhem: 'O que Deus falou comigo essa semana?'",
      "Orem especificamente pelos planos de 2026 (Viagem e Casamento).",
      "Cada um deve aben√ßoar a vida do outro com palavras de afirma√ß√£o prof√©tica.",
      "Leiam um cap√≠tulo curto da B√≠blia e destaquem uma palavra-chave.",
      "Fa√ßam um jejum de algo simples (ex: doce ou rede social) por 1 dia em prol do casal.",
      "Agrade√ßam a Deus por uma dificuldade que voc√™s j√° superaram juntos.",

      // --- ROMANCE & TOQUE ---
      "D√™em um beijo de cinema (pelo menos 10 segundos) antes de sair ou ao chegar.",
      "Fa√ßam uma massagem de 5 minutos nos p√©s ou ombros do outro.",
      "Andem de m√£os dadas sempre que estiverem caminhando juntos hoje.",
      "Fa√ßam um 'cafun√©' at√© um dos dois quase dormir.",
      "Dancem uma m√∫sica lenta na sala (mesmo que sem m√∫sica, s√≥ no ritmo).",
      "Deem um abra√ßo apertado em sil√™ncio por 1 minuto, sentindo a respira√ß√£o do outro.",
      "Preparem um banho ou um momento de relaxamento para o outro.",
      "Troquem olhares intensos por 30 segundos sem rir (vale tentar!).",
      "D√™ um beijo na testa do outro e diga 'Eu te admiro muito'.",
      "Durmam (ou tirem um cochilo) de conchinha.",

      // --- COMUNICA√á√ÉO & ELOGIOS ---
      "Elogie uma caracter√≠stica f√≠sica e uma de car√°ter do seu par hoje.",
      "Pergunte: 'Como posso orar por voc√™ hoje?' e fa√ßa isso na hora.",
      "Escreva um bilhetinho escondido (bolsa, carteira ou travesseiro) pro outro achar.",
      "Conte uma coisa que voc√™ nunca contou pra ningu√©m (segredo ou mem√≥ria).",
      "Pergunte: 'O que eu fa√ßo que faz voc√™ se sentir mais amado(a)?'",
      "Relembrem em detalhes o dia em que se conheceram ou o primeiro beijo.",
      "Definam uma palavra que resuma o relacionamento de voc√™s hoje.",
      "Pe√ßa perd√£o por algo pequeno que possa ter passado batido.",
      "Mande uma mensagem picante ou muito rom√¢ntica no meio da tarde.",
      "Diga 'Eu Te Amo' em tr√™s momentos inesperados do dia.",

      // --- DIVERS√ÉO & QUEBRA DE ROTINA ---
      "Tirem uma selfie fazendo careta e guardem na pasta 'S√≥ a gente v√™'.",
      "Joguem um jogo r√°pido (Stop, Baralho, ou at√© Pedra-Papel-Tesoura valendo massagem).",
      "Dublem uma m√∫sica famosa juntos como se estivessem num show.",
      "Fa√ßam uma 'noite sem telas': 30 minutos conversando sem celular por perto.",
      "Cozinhem algo juntos (nem que seja um miojo gourmet ou pipoca).",
      "Saiam para ver o p√¥r do sol ou a lua, nem que seja da janela.",
      "Fa√ßam um v√≠deo curto dizendo 'Eu do futuro, estamos lutando por voc√™!'.",
      "Comam a sobremesa antes do jantar (s√≥ hoje pode!).",
      "Inventem um toque de m√£o ou cumprimento secreto do casal.",
      "Fa√ßam uma caminhada no quarteir√£o apenas para conversar.",

      // --- SERVI√áO & GENTILEZA ---
      "Fa√ßa uma tarefa dom√©stica que seria do outro (lave a lou√ßa dele(a), arrume a bagun√ßa).",
      "Sirva o prato do outro na hora da refei√ß√£o com carinho.",
      "Traga um copo d'√°gua ou caf√© para o outro sem ele pedir.",
      "Arrume a cama caprichada para quando forem dormir.",
      "Pergunte: 'Posso te ajudar em algo que est√° te estressando hoje?'",
      "Deixe a toalha do outro pronta ou a escova de dentes preparada.",
      "Resolva um pequeno problema burocr√°tico para o outro.",
      "Compre ou prepare o doce/lanche favorito do outro de surpresa.",
      "Ofere√ßa-se para carregar a bolsa ou mochila do outro.",
      "Seja o primeiro a pedir desculpas se houver qualquer desentendimento.",

      // --- FUTURO & SONHOS (2026) ---
      "Imaginem em detalhes como ser√° o primeiro dia da viagem para Recife.",
      "Pesquisem juntos uma foto da Chapada ou de Pernambuco e mandem um pro outro.",
      "Guardem R$ 5,00 (ou qualquer valor extra) hoje no cofrinho/banco do app.",
      "Conversem sobre como imaginam a casa de voc√™s daqui a 5 anos.",
      "Listem 3 coisas que n√£o podem faltar no casamento de voc√™s.",
      "Fa√ßam uma ora√ß√£o aben√ßoando a vida financeira do casal.",
      "Conversem sobre nomes de filhos (mesmo que seja s√≥ brincadeira por enquanto).",
      "Definam uma meta de economia dom√©stica para esta semana.",
      "Sonhem alto: Se dinheiro n√£o fosse problema, para onde iriam amanh√£?",
      "Reafirmem o compromisso: Olhem nos olhos e digam 'Estou com voc√™ at√© o fim'."
    ];

    // Firebase (carregamento robusto)
    let firebaseReady = false;
    let db = null, dbRef = null, igrejaRef = null;
    let fbRef = null, fbPush = null, fbOnValue = null, fbRemove = null, fbUpdate = null;

    function requireFirebase() {
      if (!firebaseReady) {
        alert("Sem conex√£o/servi√ßo no momento. Tente novamente quando estiver online.");
        throw new Error("Firebase not ready");
      }
    }

    function parseMoneyBR(raw) {
      const cleaned = String(raw || "")
        .replace(/\s/g, "")
        .replace("R$", "")
        .replace(/\./g, "")
        .replace(",", ".");
      const val = Number.parseFloat(cleaned);
      return Number.isFinite(val) ? val : 0;
    }

    function getTravelStatus(val, max) {
      const perc = (val / max) * 100;
      if (perc <= 0) return "üéí Iniciando";
      if (perc < 20) return "üß≥ Arrumando Malas";
      if (perc < 50) return "üöó A Caminho";
      if (perc < 80) return "‚úàÔ∏è Quase l√°!";
      if (perc < 100) return "üèñÔ∏è Vendo o Mar";
      return "ü•Ç CONQUISTADO!";
    }

    function recalcular() {
      estado.xp = 0; estado.pe = 0; estado.ch = 0;
      estado.list.forEach(i => {
        estado.xp += Number(i.xp || 0);
        if (i.tipo === "pe") estado.pe += Number(i.val || 0);
        if (i.tipo === "ch") estado.ch += Number(i.val || 0);
      });
    }

    function getNivel() {
      let atual = niveis[0];
      for (let n of niveis) {
        if (estado.xp < n.max) { atual = n; break; }
        if (n.id === 12) atual = n;
      }
      return atual;
    }

    function renderizar() {
      // N√≠vel
      const n = getNivel();
      document.getElementById("level-name").innerText = n.nome;
      document.getElementById("xp-total").innerText = `${estado.xp} XP`;
      document.getElementById("xp-next").innerText = n.max;

      const percXP = Math.min((estado.xp / n.max) * 100, 100);
      document.getElementById("xp-bar").style.width = `${percXP}%`;

      // --- FINANCEIRO DIVERTIDO ---
      
      // Pernambuco
      document.getElementById("total-pe").innerText = fmtBRL.format(estado.pe);
      const percPE = Math.min((estado.pe / ALVO_PE) * 100, 100);
      document.getElementById("bar-pe").style.width = `${percPE}%`;
      document.getElementById("status-pe").innerText = getTravelStatus(estado.pe, ALVO_PE);

      // Chapada
      document.getElementById("total-ch").innerText = fmtBRL.format(estado.ch);
      const percCH = Math.min((estado.ch / ALVO_CH) * 100, 100);
      document.getElementById("bar-ch").style.width = `${percCH}%`;
      document.getElementById("status-ch").innerText = getTravelStatus(estado.ch, ALVO_CH);


      // Hist√≥rico
      const lista = document.getElementById("history-list");
      lista.innerHTML = "";

      [...estado.list].reverse().forEach(i => {
        const who = i.user || "N√≥s";
        const cls = who === "Marcelo" ? "bg-marcelo" : (who === "Fernanda" ? "bg-fernanda" : "bg-nos");
        const xpNum = Number(i.xp || 0);
        const xpColor = xpNum > 0 ? "var(--success)" : (xpNum < 0 ? "var(--danger)" : "#aaa");
        const valNum = Number(i.val || 0);
        const valTxt = valNum > 0 ? `(${fmtBRL.format(valNum)})` : "";
        const dateTxt = i.date || "";

        lista.innerHTML += `
          <div class="history-item">
            <div>
              <div>
                <span class="badge ${cls}">${who}</span>
                <span style="opacity:0.6; font-size:0.7rem">${dateTxt}</span>
              </div>
              <div style="margin-top:4px;">${i.desc || ""} ${valTxt}</div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              <span style="color:${xpColor}; font-weight:bold;">${xpNum > 0 ? "+" : ""}${xpNum}</span>
              ${firebaseReady ? `<i class="fas fa-times" style="opacity:0.3; cursor:pointer;" onclick="remover('${i.id}')"></i>` : ``}
            </div>
          </div>
        `;
      });

      if (!estado.list.length) {
        lista.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa;">Sem registros ainda.</div>`;
      }

      // Presen√ßa na Igreja
      const igrejaTotalEl = document.getElementById("igreja-total");
      const igrejaLastEl = document.getElementById("igreja-last");

      if (igrejaTotalEl) {
        igrejaTotalEl.innerText = estado.igrejaCount || 0;
      }
      if (igrejaLastEl) {
         igrejaLastEl.innerText = estado.igrejaLast ? `√öltimo registro: ${estado.igrejaLast.date}` : "√öltimo registro: ‚Äî";
      }
    }

    // --- FUN√á√ïES DE METAS ---
    
    window.renderizarMetas = () => {
      const dono = document.getElementById("meta-dono").value;
      const listaEl = document.getElementById("lista-metas");
      if (!listaEl) return;
      
      if (!dono) {
         listaEl.innerHTML = `<div style="text-align:center; padding:15px; color:#aaa; font-size:0.8rem;">Selecione seu nome acima para ver as metas.</div>`;
         return;
      }

      listaEl.innerHTML = "";
      const dados = estado.metas && estado.metas[dono] ? estado.metas[dono] : {};
      const chaves = Object.keys(dados);

      if (chaves.length === 0) {
        listaEl.innerHTML = `<div style="text-align:center; padding:15px; opacity:0.6;">Nenhuma meta definida ainda. Bora sonhar?</div>`;
        return;
      }

      chaves.forEach(key => {
        const item = dados[key];
        listaEl.innerHTML += `
          <div class="history-item">
            <div style="flex:1; padding-right:10px;">
              <i class="fas fa-star" style="color:#ffd700; font-size:0.7rem; margin-right:5px;"></i>
              ${item.texto}
            </div>
            <div style="display:flex; gap:10px;">
               <i class="fas fa-pen" style="color:var(--accent-blue); opacity:0.6; cursor:pointer;" onclick="editarMeta('${dono}', '${key}')"></i>
               <i class="fas fa-trash" style="color:var(--danger); opacity:0.6; cursor:pointer;" onclick="apagarMeta('${dono}', '${key}')"></i>
            </div>
          </div>
        `;
      });
    };

    window.adicionarMeta = () => {
      requireFirebase();
      const dono = document.getElementById("meta-dono").value;
      
      if (!dono) return alert("Selecione quem √© voc√™ na lista antes de adicionar!");

      const input = document.getElementById("meta-texto");
      const texto = input.value.trim();

      if (!texto) return alert("Escreva alguma coisa!");

      fbPush(fbRef(db, `metas/${dono}`), {
        texto: texto,
        criadoEm: new Date().toLocaleDateString()
      });

      input.value = ""; 
    };

    window.editarMeta = (dono, id) => {
      requireFirebase();
      const metaAtual = estado.metas[dono][id].texto;
      const novoTexto = prompt("Editar meta:", metaAtual);

      if (novoTexto && novoTexto !== metaAtual) {
         fbUpdate(fbRef(db, `metas/${dono}/${id}`), {
           texto: novoTexto
         });
      }
    };

    window.apagarMeta = (dono, id) => {
      requireFirebase();
      if(confirm("J√° completou ou quer desistir dessa meta?")) {
        fbRemove(fbRef(db, `metas/${dono}/${id}`));
      }
    };

    // Fun√ß√µes globais (UI)
    window.verProximoPremio = () => {
      const n = getNivel();
      document.getElementById("premio-txt").innerText = n.premio;
      document.getElementById("modal-premio").style.display = "flex";
    };

    window.sortearMissoes = () => {
      const r1 = missoes[Math.floor(Math.random() * missoes.length)];
      const r2 = missoes[Math.floor(Math.random() * missoes.length)];
      document.getElementById("txt-marcelo").innerText = r1;
      document.getElementById("txt-fernanda").innerText = r2;
      document.getElementById("mission-area").classList.remove("hidden");
    };

    window.completarMissao = (sucesso) => {
      if (sucesso) window.registrarAcao(20, "Miss√£o Dupla Cumprida!");
      else window.registrarAcao(-10, "Miss√£o Falhou");
      document.getElementById("mission-area").classList.add("hidden");
    };

    window.fotoTirada = () => {
      alert("Foto tirada! Agora abra o √Ålbum (link abaixo) e adicione ela l√°.");
    };

    window.registrarAcao = (xp, desc) => {
      requireFirebase();
      const user = document.getElementById("user-select").value || "N√≥s";
      fbPush(dbRef, {
        date: new Date().toLocaleDateString(),
        user,
        desc,
        xp: Number(xp || 0),
        val: 0,
        tipo: null
      });
    };

    window.depositar = (tipo) => {
      requireFirebase();
      const user = document.getElementById("user-select").value || "N√≥s";
      const raw = document.getElementById("money-input").value;
      const val = parseMoneyBR(raw);
      if (!val) return alert("Digite um valor!");

      const dest = tipo === "pe" ? "Recife" : "Chapada";
      const desc = `Poupan√ßa ${dest}`;
      
      fbPush(dbRef, {
        date: new Date().toLocaleDateString(),
        user,
        desc,
        xp: 5,
        val,
        tipo
      });

      document.getElementById("money-input").value = "";
      alert(`R$ ${val} guardado para ${dest}! üí∏`);
    };

    window.remover = (id) => {
      requireFirebase();
      if (confirm("Apagar?")) fbRemove(fbRef(db, `historico/${id}`));
    };

    window.limparTudo = () => {
      requireFirebase();
      if (confirm("Resetar TUDO (XP + Banco + Di√°rio)?")) {
        fbRemove(dbRef);
      }
    };

    window.marcarIgrejaHoje = () => {
      requireFirebase();
      const hoje = new Date();
      const date = hoje.toLocaleDateString();
      const iso = hoje.toISOString();

      if (estado.igrejaLast && estado.igrejaLast.date === date) {
        if (!confirm("J√° tem presen√ßa registrada para hoje. Marcar de novo?")) return;
      }

      fbPush(igrejaRef, { date, dateISO: iso, obs: "Culto de domingo", xp: 20 });
      fbPush(dbRef, { date, user: "N√≥s", desc: "Fomos √† igreja hoje üôè", xp: 20, val: 0, tipo: "igreja" });

      alert("Presen√ßa na igreja registrada! Deus aben√ßoe voc√™s üôè");
    };

    // Inicializa√ß√£o
    (async () => {
      try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
        const { getDatabase, ref, push, onValue, remove, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");

        const firebaseConfig = {
          apiKey: "AIzaSyC8YA9o9KVlKW1j9Ps2gqwYYWJDnFt6Go4",
          authDomain: "casal2026-888ce.firebaseapp.com",
          databaseURL: "https://casal2026-888ce-default-rtdb.firebaseio.com",
          projectId: "casal2026-888ce",
          storageBucket: "casal2026-888ce.firebasestorage.app",
          messagingSenderId: "314398386836",
          appId: "1:314398386836:web:e401b22d85e7bbe5e9e281",
          measurementId: "G-RHXB26B178"
        };

        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        
        dbRef = ref(db, "historico");
        igrejaRef = ref(db, "igreja");
        const metasRef = ref(db, "metas");

        fbRef = ref; fbPush = push; fbOnValue = onValue; fbRemove = remove; fbUpdate = update;

        firebaseReady = true;
        setStatus('<i class="fas fa-wifi"></i> Online', "var(--success)");

        fbOnValue(dbRef, (snap) => {
          const data = snap.val();
          estado.list = [];
          if (data) { Object.keys(data).forEach(k => estado.list.push({ id: k, ...data[k] })); }
          recalcular();
          renderizar();
        });

        fbOnValue(igrejaRef, (snap) => {
          const data = snap.val();
          let count = 0; let last = null;
          if (data) {
            Object.keys(data).forEach((k) => {
              const item = data[k]; count++;
              if (!last || new Date(item.dateISO || item.date) > new Date(last?.dateISO || last?.date || 0)) last = item;
            });
          }
          estado.igrejaCount = count; estado.igrejaLast = last;
          renderizar();
        });

        fbOnValue(metasRef, (snap) => {
          estado.metas = snap.val() || {};
          renderizarMetas();
        });

        renderizar();

      } catch (err) {
        console.error(err);
        setStatus('<i class="fas fa-wifi"></i> Offline', "var(--danger)");
        renderizar();
      }
    })();
  </script>
</body>
</html>