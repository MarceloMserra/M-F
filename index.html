<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />
  <title>Nossa Jornada | Marcelo & Fernanda</title>

  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Nosso Mundo" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
  <link rel="icon" type="image/png" href="/images/icon-192.png" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: 1px solid rgba(255, 255, 255, 0.15);
      --text-color: #ffffff;
      --accent-pink: #ff758c;
      --accent-blue: #4facfe;
      --success: #00b09b;
      --danger: #ff5f6d;
      --gold: #ffd700;
      --bible-bg: linear-gradient(145deg, #1a1a1a, #222);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      padding-bottom: 90px;
      color: var(--text-color);
      min-height: 100vh;
      background: url('images/fundo.jpg') no-repeat center center fixed;
      background-size: cover;
      background-attachment: fixed;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(4px);
      z-index: -1;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .header h1 { font-size: 1.6rem; margin: 0; letter-spacing: 1px; }
    .header p { font-size: 0.85rem; opacity: 0.8; font-weight: 300; margin-top: 5px; }

    .btn-agent {
      background: linear-gradient(45deg, #FF9500, #FF5E3A);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.8rem;
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(255, 94, 58, 0.4);
      text-decoration: none;
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      border: var(--glass-border);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    h3 { margin-top: 0; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }

    /* ESTILO EXCLUSIVO DO DEVOCIONAL */
    .devocional-card {
        border: 1px solid rgba(255, 215, 0, 0.2);
        background: rgba(0,0,0,0.4);
    }
    .dev-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 10px;
    }
    .dev-date {
        font-family: 'Playfair Display', serif;
        font-style: italic;
        color: var(--gold);
        font-size: 0.9rem;
    }
    .dev-title {
        font-size: 1.3rem;
        margin: 0 0 10px 0;
        font-family: 'Playfair Display', serif;
        color: white;
        line-height: 1.2;
    }
    .dev-verse-box {
        background: rgba(255, 215, 0, 0.05);
        border-left: 3px solid var(--gold);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 0 10px 10px 0;
        position: relative;
    }
    .quote-icon {
        position: absolute;
        top: 10px; left: 10px;
        font-size: 2rem;
        color: var(--gold);
        opacity: 0.1;
    }
    .dev-verse {
        font-family: 'Playfair Display', serif;
        font-style: italic;
        font-size: 1rem;
        color: #f0f0f0;
        margin: 0;
        line-height: 1.5;
        position: relative;
        z-index: 2;
    }
    .dev-text {
        font-size: 0.95rem;
        line-height: 1.6;
        color: rgba(255,255,255,0.9);
        margin-bottom: 20px;
        text-align: justify;
    }
    .btn-amem {
        background: linear-gradient(135deg, #b8860b 0%, #daa520 100%);
        color: #000;
        font-weight: 800;
        letter-spacing: 0.5px;
        border: none;
        box-shadow: 0 4px 15px rgba(218, 165, 32, 0.3);
    }
    .btn-amem:disabled {
        background: #444;
        color: #aaa;
        box-shadow: none;
        cursor: not-allowed;
    }

    /* XP BAR */
    .level-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer; }
    .xp-track { width: 100%; height: 12px; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
      width: 0%; transition: width 1s ease;
    }

    /* TRAVEL TRACKER */
    .travel-track-container { margin-top: 15px; position: relative; padding-top: 20px; }
    .travel-track { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; }
    .travel-fill { height: 100%; border-radius: 10px; width: 0%; position: relative; transition: width 1.5s ease; }
    .travel-icon { position: absolute; right: -10px; top: -22px; font-size: 1.1rem; transition: right 1.5s; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
    .travel-stats { display: flex; justify-content: space-between; font-size: 0.7rem; color: #ccc; margin-top: 5px; }

    /* FORM & BUTTONS */
    button { border: none; outline: none; cursor: pointer; font-family: inherit; font-weight: 600; transition: 0.2s; }
    button:active { transform: scale(0.96); }
    .btn-main { width: 100%; padding: 14px; border-radius: 12px; background: var(--primary-gradient); color: white; font-size: 1rem; }
    
    .grid-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .action-card {
      background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px; padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 8px; color: white; font-size: 0.85rem;
    }
    .act-love { border-color: var(--accent-pink); color: var(--accent-pink); }
    .act-peace { border-color: var(--success); color: var(--success); }
    .act-bad { border-color: var(--danger); color: var(--danger); }

    .finance-group { display: flex; gap: 8px; margin-bottom: 10px; }
    .input-glass {
      flex: 1; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3); color: white; font-family: inherit; font-size: 0.9rem;
    }
    .input-glass option { background: #333; }
    .btn-deposit { flex: 1; padding: 12px; border-radius: 10px; font-size: 0.9rem; color: #fff; }

    .history-list { max-height: 250px; overflow-y: auto; }
    .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; }
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; margin-right: 5px; }
    .bg-marcelo { background: var(--accent-blue); } .bg-fernanda { background: var(--accent-pink); } .bg-nos { background: var(--gold); color: #000; }

    /* MODAL */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
      display: none; justify-content: center; align-items: center; z-index: 100; padding: 20px;
    }
    .modal-box {
      background: #2d3436; border-radius: 20px; padding: 30px; text-align: center;
      border: 2px solid var(--accent-pink); max-width: 350px; animation: popUp 0.4s;
    }
    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .hidden { display: none; }
    .text-gold { color: var(--gold); }
    .text-success { color: var(--success); }
    .status-pill { background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 12px; font-size: 0.65rem; }
  </style>
</head>

<body>
  <div class="header">
    <h1>Marcelo & Fernanda</h1>
    <p>Construindo nosso 2026 üíç</p>

    <a href="https://conselheirocasal.netlify.app/" target="_blank" class="btn-agent" rel="noopener">
      <i class="fas fa-robot"></i> Conselheiro Virtual
    </a>

    <div id="status-conn" style="font-size: 0.7rem; color: var(--accent-blue); margin-top: 10px;">
      <i class="fas fa-circle-notch fa-spin"></i> Conectando...
    </div>
  </div>

  <div id="modal-premio" class="modal">
    <div class="modal-box">
      <i class="fas fa-trophy fa-3x" style="color: #ffd700; margin-bottom: 15px;"></i>
      <h2 style="color:white; margin-bottom:10px;">N√çVEL NOVO!</h2>
      <p id="premio-txt" style="color:#ccc; margin-bottom:20px; line-height:1.5;">...</p>
      <button class="btn-main" onclick="document.getElementById('modal-premio').style.display='none'">Oba! Vamos nessa!</button>
    </div>
  </div>

  <div class="card devocional-card">
    <div class="dev-header">
        <h3><i class="fas fa-bible text-gold"></i> Alimento Di√°rio</h3>
        <span id="data-hoje" class="dev-date">--/--</span>
    </div>
    
    <div id="dev-loading" style="text-align:center; padding:20px; color:#aaa;">
        <i class="fas fa-circle-notch fa-spin text-gold"></i> Buscando a Palavra...
    </div>

    <div id="dev-content" class="hidden">
        <h2 id="dev-titulo" class="dev-title">...</h2>
        
        <div class="dev-verse-box">
            <i class="fas fa-quote-left quote-icon"></i>
            <p id="dev-verso" class="dev-verse">...</p>
        </div>
        
        <p id="dev-texto" class="dev-text">...</p>

        <button id="btn-amem" class="btn-main btn-amem" onclick="lerDevocional()">
           <i class="fas fa-praying-hands"></i> Recebemos esta Palavra (+20 XP)
        </button>
    </div>
  </div>

  <div class="card" onclick="verProximoPremio()">
    <div class="level-header">
      <h2 id="level-name">Carregando...</h2>
      <span id="xp-total" style="font-weight:bold; color:var(--accent-pink)">0 XP</span>
    </div>
    <div class="xp-track"><div class="xp-fill" id="xp-bar"></div></div>
    <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:0.75rem; color:#aaa;">
      <span>Toque para ver o pr√™mio</span>
      <span>Pr√≥x: <span id="xp-next">100</span></span>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-heart text-gold"></i> Miss√£o do Casal</h3>
    <button class="btn-main" onclick="sortearMissoes()">
      <i class="fas fa-dice"></i> Sortear Desafio
    </button>

    <div id="mission-area" class="hidden" style="margin-top: 15px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
      <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px dashed rgba(255,255,255,0.2)">
        <strong style="color:var(--accent-blue)">MARCELO:</strong>
        <div id="txt-marcelo" style="font-style:italic; margin-top:3px;">...</div>
      </div>
      <div style="margin-bottom: 15px;">
        <strong style="color:var(--accent-pink)">FERNANDA:</strong>
        <div id="txt-fernanda" style="font-style:italic; margin-top:3px;">...</div>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn-main" style="background:var(--success)" onclick="completarMissao(true)">Feito! (+20)</button>
        <button class="btn-main" style="background:rgba(255,255,255,0.1); border:1px solid #666" onclick="completarMissao(false)">Falhamos</button>
      </div>
    </div>
  </div>

  <div class="grid-actions" style="margin-bottom: 20px;">
    <button class="action-card act-peace" onclick="registrarAcao(10, 'üïäÔ∏è Dia de Paz')"><i class="fas fa-hand-holding-heart fa-2x"></i><span>Dia de Paz</span></button>
    <button class="action-card act-love" onclick="registrarAcao(5, '‚ù§Ô∏è Carinho')"><i class="fas fa-kiss-wink-heart fa-2x"></i><span>Carinho</span></button>
    <button class="action-card act-bad" onclick="registrarAcao(-15, 'üò† Briga')"><i class="fas fa-angry fa-2x"></i><span>Briga</span></button>
    <button class="action-card" onclick="document.getElementById('camera-input').click()"><i class="fas fa-camera fa-2x"></i><span>Foto</span></button>
    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="fotoTirada()" />
  </div>

  <div class="card">
    <h3><i class="fas fa-plane-departure text-gold"></i> Banco de Viagens</h3>
    <div class="finance-group">
      <select id="user-select" class="input-glass" style="max-width: 110px;">
        <option value="Marcelo">Marcelo</option><option value="Fernanda">Fernanda</option><option value="N√≥s">N√≥s</option>
      </select>
      <input type="text" id="money-input" class="input-glass" placeholder="R$ 0,00" inputmode="decimal" />
    </div>
    <div class="finance-group">
      <button class="btn-deposit" style="background:var(--accent-pink)" onclick="depositar('pe')">Recife/PE</button>
      <button class="btn-deposit" style="background:var(--accent-blue)" onclick="depositar('ch')">Chapada</button>
    </div>

    <div style="margin-top:25px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; color:var(--accent-pink)">Pernambuco ‚òÄÔ∏è</span>
        <span id="status-pe" class="status-pill">üéí Iniciando</span>
      </div>
      <div class="travel-track-container">
        <div class="travel-track"><div class="travel-fill" id="bar-pe" style="background:var(--accent-pink);"><i class="fas fa-plane travel-icon" style="color:var(--accent-pink)"></i></div></div>
      </div>
      <div class="travel-stats"><span id="total-pe">R$ 0,00</span><span>Meta: R$ 7.200</span></div>
    </div>

    <div style="margin-top:25px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; color:var(--accent-blue)">Chapada üèûÔ∏è</span>
        <span id="status-ch" class="status-pill">üéí Iniciando</span>
      </div>
      <div class="travel-track-container">
        <div class="travel-track"><div class="travel-fill" id="bar-ch" style="background:var(--accent-blue);"><i class="fas fa-car-side travel-icon" style="color:var(--accent-blue)"></i></div></div>
      </div>
      <div class="travel-stats"><span id="total-ch">R$ 0,00</span><span>Meta: R$ 2.500</span></div>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-bullseye text-gold"></i> Metas 2026</h3>
    <div class="finance-group">
      <select id="meta-dono" class="input-glass" onchange="renderizarMetas()" style="max-width: 130px;">
        <option value="" disabled selected>Quem √© voc√™?</option>
        <option value="Marcelo">Marcelo</option>
        <option value="Fernanda">Fernanda</option>
      </select>
      <input type="text" id="meta-texto" class="input-glass" placeholder="Nova meta..." />
      <button class="btn-deposit" style="background:var(--success); flex:0 0 50px;" onclick="adicionarMeta()"><i class="fas fa-plus"></i></button>
    </div>
    <div id="lista-metas" class="history-list" style="margin-top:10px; max-height: 200px;">
      <div style="text-align:center; padding:15px; color:#aaa; font-size:0.8rem;">Selecione seu nome.</div>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-church text-gold"></i> Presen√ßa na Igreja</h3>
    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
      <div><div id="igreja-total" style="font-size:2rem; font-weight:bold;">0</div><div style="font-size:0.8rem; opacity:0.8;">Domingos</div></div>
      <button class="btn-main" style="width:auto; padding:10px 16px; background:linear-gradient(135deg,#22c55e,#16a34a);" onclick="marcarIgrejaHoje()"><i class="fas fa-check-circle"></i> Marcar hoje</button>
    </div>
    <div id="igreja-last" style="margin-top:10px; font-size:0.8rem; opacity:0.8;">√öltimo registro: ‚Äî</div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h3><i class="fas fa-history"></i> Di√°rio</h3>
      <i class="fas fa-trash" style="color:#666; cursor:pointer;" onclick="limparTudo()" title="Resetar Tudo"></i>
    </div>
    <div id="history-list" class="history-list"><div style="text-align:center; padding:20px; color:#aaa;">Carregando...</div></div>
  </div>

  <script type="module">
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => { navigator.serviceWorker.register("/sw.js").catch(() => {}); });
    }

    const statusEl = document.getElementById("status-conn");
    function setStatus(html, cssColor) { statusEl.innerHTML = html; statusEl.style.color = cssColor; }
    window.addEventListener("offline", () => { setStatus('<i class="fas fa-wifi"></i> Offline', "var(--danger)"); });
    window.addEventListener("online", () => { setStatus('<i class="fas fa-circle-notch fa-spin"></i> Reconectando...', "var(--accent-blue)"); });

    const fmtBRL = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });

    let estado = { xp: 0, pe: 0, ch: 0, list: [], igrejaCount: 0, igrejaLast: null, metas: {} };
    const ALVO_PE = 7200; const ALVO_CH = 2500;

    const niveis = [
      {id:1, max:100, nome:"In√≠cio", premio:"Piquenique na Ermida Dom Bosco"},
      {id:2, max:300, nome:"Aprendizes", premio:"Caminhada no Pont√£o + √Ågua de Coco"},
      {id:3, max:600, nome:"Parceiros", premio:"Eix√£o do Lazer + Fotos na SQS 308"},
      {id:4, max:1000, nome:"C√∫mplices", premio:"CCBB Cultural + Passeio no Jardim"},
      {id:5, max:1500, nome:"Namorados", premio:"Pastel na Torre de TV"},
      {id:6, max:2200, nome:"Noivos", premio:"Cine Drive-in (Noite Retr√¥)"},
      {id:7, max:3000, nome:"Guardi√µes", premio:"Trilha na √Ågua Mineral"},
      {id:8, max:4000, nome:"Guerreiros", premio:"Visita ao Templo da LBV (Paz)"},
      {id:9, max:5500, nome:"Inabal√°veis", premio:"Jardim Bot√¢nico (Piquenique)"},
      {id:10, max:7000, nome:"Alma G√™mea", premio:"Torre Digital (Vista do DF)"},
      {id:11, max:9000, nome:"Realeza", premio:"Jantar de Gala em Casa"},
      {id:12, max:12000, nome:"Lend√°rios", premio:"VIAGEM PARA PERNAMBUCO!"}
    ];

    const missoes = [
      "Orem juntos agradecendo por tr√™s coisas espec√≠ficas de hoje.",
      "Leiam Prov√©rbios 31 juntos e comentem um vers√≠culo.",
      "Fa√ßam uma ora√ß√£o de m√£os dadas pela fam√≠lia.",
      "Escolham um louvor que marque a hist√≥ria de voc√™s e ou√ßam.",
      "D√™em um beijo de cinema (10 seg) antes de sair.",
      "Fa√ßam massagem nos p√©s ou ombros do outro.",
      "Elogie uma caracter√≠stica de car√°ter do seu par hoje.",
      "Pergunte: 'Como posso orar por voc√™ hoje?' e ore.",
      "Escreva um bilhetinho escondido pro outro achar.",
      "Diga 'Eu Te Amo' em tr√™s momentos inesperados.",
      "Fa√ßam uma 'noite sem telas': 30 min conversando.",
      "Cozinhem algo juntos (nem que seja pipoca).",
      "Fa√ßa uma tarefa dom√©stica que seria do outro.",
      "Sirva o prato do outro na hora da refei√ß√£o.",
      "Arrume a cama caprichada para quando forem dormir.",
      "Guardem R$ 5,00 extras no cofrinho do app hoje."
    ];

    let firebaseReady = false;
    let db = null, dbRef = null, igrejaRef = null;
    let fbRef = null, fbPush = null, fbOnValue = null, fbRemove = null, fbUpdate = null;

    function requireFirebase() { if (!firebaseReady) { alert("Conectando... Tente em instantes."); throw new Error("Firebase not ready"); } }
    function parseMoneyBR(raw) { const v = Number.parseFloat(String(raw||"").replace(/\s/g,"").replace("R$","").replace(/\./g,"").replace(",",".")); return Number.isFinite(v)?v:0; }
    function getTravelStatus(val, max) { const p = (val/max)*100; if(p<=0)return "üéí Iniciando"; if(p<20)return "üß≥ Arrumando"; if(p<50)return "üöó A Caminho"; if(p<80)return "‚úàÔ∏è Quase l√°"; if(p<100)return "üèñÔ∏è Vendo o Mar"; return "ü•Ç CONQUISTADO!"; }

    // --- DEVOCIONAL ---
    window.carregarDevocional = () => {
        if(!db) return;
        const hoje = new Date();
        const dia = String(hoje.getDate()).padStart(2, '0');
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const chaveData = `${mes}-${dia}`;
        
        // Data formatada
        const mesesExt = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
        document.getElementById("data-hoje").innerText = `${dia} de ${mesesExt[hoje.getMonth()]}`;

        const path = `devocionais/${chaveData}`;
        
        fbOnValue(fbRef(db, path), (snap) => {
            document.getElementById("dev-loading").classList.add("hidden");
            document.getElementById("dev-content").classList.remove("hidden");
            const data = snap.val();
            
            if (data) {
               document.getElementById("dev-titulo").innerText = data.titulo;
               document.getElementById("dev-verso").innerText = data.verso;
               document.getElementById("dev-texto").innerText = data.texto;
            } else {
               document.getElementById("dev-titulo").innerText = "Aguardando Palavra...";
               document.getElementById("dev-verso").innerText = "Salmos 119:105";
               document.getElementById("dev-texto").innerText = "Hoje n√£o h√° devocional cadastrado para esta data ("+chaveData+"). Verifique o banco de dados.";
            }

            const lidoKey = `lido-${chaveData}-${hoje.getFullYear()}`;
            const btn = document.getElementById("btn-amem");
            if(localStorage.getItem(lidoKey)) {
                 btn.innerHTML = '<i class="fas fa-check"></i> Palavra Recebida';
                 btn.disabled = true;
                 btn.style.opacity = "0.5";
                 btn.style.background = "#333";
            } else {
                 btn.innerHTML = '<i class="fas fa-praying-hands"></i> Recebemos esta Palavra (+20 XP)';
                 btn.disabled = false;
                 btn.style.opacity = "1";
                 btn.style.background = "linear-gradient(135deg, #b8860b 0%, #daa520 100%)";
            }
        });
    };

    window.lerDevocional = () => {
        requireFirebase();
        const hoje = new Date();
        const dia = String(hoje.getDate()).padStart(2, '0');
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const chave = `lido-${mes}-${dia}-${hoje.getFullYear()}`;
        
        const btn = document.getElementById("btn-amem");
        if(btn.disabled) return;

        fbPush(dbRef, { date: new Date().toLocaleDateString(), user: "N√≥s", desc: "Devocional lido üìñ", xp: 20, val: 0, tipo: "devocional" });
        localStorage.setItem(chave, "true");
        
        btn.innerHTML = '<i class="fas fa-check"></i> Palavra Recebida';
        btn.disabled = true;
        btn.style.background = "#333";
        alert("Am√©m! Palavra guardada no cora√ß√£o.");
    };

    // --- Core Logic ---
    function recalcular() {
      estado.xp = 0; estado.pe = 0; estado.ch = 0;
      estado.list.forEach(i => {
        estado.xp += Number(i.xp || 0);
        if (i.tipo === "pe") estado.pe += Number(i.val || 0);
        if (i.tipo === "ch") estado.ch += Number(i.val || 0);
      });
    }

    function getNivel() {
      let atual = niveis[0];
      for (let n of niveis) { if (estado.xp < n.max) { atual = n; break; } if (n.id === 12) atual = n; }
      return atual;
    }

    function renderizar() {
      const n = getNivel();
      document.getElementById("level-name").innerText = n.nome;
      document.getElementById("xp-total").innerText = `${estado.xp} XP`;
      document.getElementById("xp-next").innerText = n.max;
      document.getElementById("xp-bar").style.width = `${Math.min((estado.xp/n.max)*100,100)}%`;

      document.getElementById("total-pe").innerText = fmtBRL.format(estado.pe);
      document.getElementById("bar-pe").style.width = `${Math.min((estado.pe/ALVO_PE)*100,100)}%`;
      document.getElementById("status-pe").innerText = getTravelStatus(estado.pe, ALVO_PE);

      document.getElementById("total-ch").innerText = fmtBRL.format(estado.ch);
      document.getElementById("bar-ch").style.width = `${Math.min((estado.ch/ALVO_CH)*100,100)}%`;
      document.getElementById("status-ch").innerText = getTravelStatus(estado.ch, ALVO_CH);

      const lista = document.getElementById("history-list");
      lista.innerHTML = "";
      [...estado.list].reverse().forEach(i => {
        const who = i.user || "N√≥s";
        const cls = who === "Marcelo"?"bg-marcelo":(who==="Fernanda"?"bg-fernanda":"bg-nos");
        const xpNum = Number(i.xp||0);
        const xpColor = xpNum>0?"var(--success)":(xpNum<0?"var(--danger)":"#aaa");
        const valTxt = i.val>0 ? `(${fmtBRL.format(i.val)})` : "";
        lista.innerHTML += `
          <div class="history-item">
            <div>
              <div><span class="badge ${cls}">${who}</span> <span style="opacity:0.6; font-size:0.7rem">${i.date||""}</span></div>
              <div style="margin-top:4px;">${i.desc||""} ${valTxt}</div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              <span style="color:${xpColor}; font-weight:bold;">${xpNum>0?"+":""}${xpNum}</span>
              ${firebaseReady ? `<i class="fas fa-times" style="opacity:0.3; cursor:pointer;" onclick="remover('${i.id}')"></i>` : ``}
            </div>
          </div>`;
      });
      if (!estado.list.length) lista.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa;">Sem registros.</div>`;

      document.getElementById("igreja-total").innerText = estado.igrejaCount || 0;
      document.getElementById("igreja-last").innerText = estado.igrejaLast ? `√öltimo registro: ${estado.igrejaLast.date}` : "√öltimo registro: ‚Äî";
    }

    // --- UI Actions ---
    window.renderizarMetas = () => {
      const dono = document.getElementById("meta-dono").value;
      const listaEl = document.getElementById("lista-metas");
      if (!listaEl) return;
      if (!dono) { listaEl.innerHTML = `<div style="text-align:center; padding:15px; color:#aaa; font-size:0.8rem;">Selecione seu nome.</div>`; return; }
      listaEl.innerHTML = "";
      const dados = estado.metas && estado.metas[dono] ? estado.metas[dono] : {};
      const chaves = Object.keys(dados);
      if (chaves.length === 0) { listaEl.innerHTML = `<div style="text-align:center; padding:15px; opacity:0.6;">Nenhuma meta ainda.</div>`; return; }
      chaves.forEach(key => {
        const item = dados[key];
        listaEl.innerHTML += `
          <div class="history-item">
            <div style="flex:1; padding-right:10px;"><i class="fas fa-star" style="color:#ffd700; font-size:0.7rem; margin-right:5px;"></i>${item.texto}</div>
            <div style="display:flex; gap:10px;">
               <i class="fas fa-pen" style="color:var(--accent-blue); opacity:0.6; cursor:pointer;" onclick="editarMeta('${dono}', '${key}')"></i>
               <i class="fas fa-trash" style="color:var(--danger); opacity:0.6; cursor:pointer;" onclick="apagarMeta('${dono}', '${key}')"></i>
            </div>
          </div>`;
      });
    };

    window.adicionarMeta = () => {
      requireFirebase();
      const dono = document.getElementById("meta-dono").value;
      if (!dono) return alert("Selecione quem √© voc√™!");
      const input = document.getElementById("meta-texto");
      const texto = input.value.trim();
      if (!texto) return alert("Escreva algo!");
      fbPush(fbRef(db, `metas/${dono}`), { texto: texto, criadoEm: new Date().toLocaleDateString() });
      input.value = ""; 
    };

    window.editarMeta = (dono, id) => {
      requireFirebase();
      const metaAtual = estado.metas[dono][id].texto;
      const novoTexto = prompt("Editar meta:", metaAtual);
      if (novoTexto && novoTexto !== metaAtual) { fbUpdate(fbRef(db, `metas/${dono}/${id}`), { texto: novoTexto }); }
    };

    window.apagarMeta = (dono, id) => {
      requireFirebase();
      if(confirm("Apagar meta?")) { fbRemove(fbRef(db, `metas/${dono}/${id}`)); }
    };

    window.verProximoPremio = () => {
      const n = getNivel();
      document.getElementById("premio-txt").innerText = n.premio;
      document.getElementById("modal-premio").style.display = "flex";
    };

    window.sortearMissoes = () => {
      const r1 = missoes[Math.floor(Math.random() * missoes.length)];
      const r2 = missoes[Math.floor(Math.random() * missoes.length)];
      document.getElementById("txt-marcelo").innerText = r1;
      document.getElementById("txt-fernanda").innerText = r2;
      document.getElementById("mission-area").classList.remove("hidden");
    };

    window.completarMissao = (sucesso) => {
      if (sucesso) window.registrarAcao(20, "Miss√£o Dupla Cumprida!");
      else window.registrarAcao(-10, "Miss√£o Falhou");
      document.getElementById("mission-area").classList.add("hidden");
    };

    window.fotoTirada = () => { alert("Foto tirada! Abra o √Ålbum para salvar."); };

    window.registrarAcao = (xp, desc) => {
      requireFirebase();
      const user = document.getElementById("user-select").value || "N√≥s";
      fbPush(dbRef, { date: new Date().toLocaleDateString(), user, desc, xp: Number(xp || 0), val: 0, tipo: null });
    };

    window.depositar = (tipo) => {
      requireFirebase();
      const user = document.getElementById("user-select").value || "N√≥s";
      const raw = document.getElementById("money-input").value;
      const val = parseMoneyBR(raw);
      if (!val) return alert("Digite um valor!");
      const dest = tipo === "pe" ? "Recife" : "Chapada";
      const desc = `Poupan√ßa ${dest}`;
      fbPush(dbRef, { date: new Date().toLocaleDateString(), user, desc, xp: 5, val, tipo });
      document.getElementById("money-input").value = "";
      alert(`R$ ${val} guardado para ${dest}! üí∏`);
    };

    window.remover = (id) => { requireFirebase(); if (confirm("Apagar registro?")) fbRemove(fbRef(db, `historico/${id}`)); };
    window.limparTudo = () => { requireFirebase(); if (confirm("Resetar TUDO?")) { fbRemove(dbRef); } };

    window.marcarIgrejaHoje = () => {
      requireFirebase();
      const hoje = new Date();
      const date = hoje.toLocaleDateString();
      const iso = hoje.toISOString();
      if (estado.igrejaLast && estado.igrejaLast.date === date) { if (!confirm("J√° marcou hoje. Marcar de novo?")) return; }
      fbPush(igrejaRef, { date, dateISO: iso, obs: "Culto", xp: 20 });
      fbPush(dbRef, { date, user: "N√≥s", desc: "Fomos √† igreja hoje üôè", xp: 20, val: 0, tipo: "igreja" });
      alert("Presen√ßa registrada! Deus aben√ßoe.");
    };

    // INIT
    (async () => {
      try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
        const { getDatabase, ref, push, onValue, remove, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");

        const firebaseConfig = {
          apiKey: "AIzaSyC8YA9o9KVlKW1j9Ps2gqwYYWJDnFt6Go4",
          authDomain: "casal2026-888ce.firebaseapp.com",
          databaseURL: "https://casal2026-888ce-default-rtdb.firebaseio.com",
          projectId: "casal2026-888ce",
          storageBucket: "casal2026-888ce.firebasestorage.app",
          messagingSenderId: "314398386836",
          appId: "1:314398386836:web:e401b22d85e7bbe5e9e281",
          measurementId: "G-RHXB26B178"
        };

        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        
        dbRef = ref(db, "historico");
        igrejaRef = ref(db, "igreja");
        const metasRef = ref(db, "metas");

        fbRef = ref; fbPush = push; fbOnValue = onValue; fbRemove = remove; fbUpdate = update;

        firebaseReady = true;
        setStatus('<i class="fas fa-wifi"></i> Online', "var(--success)");

        fbOnValue(dbRef, (snap) => {
          const data = snap.val();
          estado.list = [];
          if (data) { Object.keys(data).forEach(k => estado.list.push({ id: k, ...data[k] })); }
          recalcular();
          renderizar();
        });

        fbOnValue(igrejaRef, (snap) => {
          const data = snap.val();
          let count = 0; let last = null;
          if (data) {
            Object.keys(data).forEach((k) => {
              const item = data[k]; count++;
              if (!last || new Date(item.dateISO || item.date) > new Date(last?.dateISO || last?.date || 0)) last = item;
            });
          }
          estado.igrejaCount = count; estado.igrejaLast = last;
          renderizar();
        });

        fbOnValue(metasRef, (snap) => {
          estado.metas = snap.val() || {};
          renderizarMetas();
        });

        // Inicia o devocional
        window.carregarDevocional();
        renderizar();

      } catch (err) {
        console.error(err);
        setStatus('<i class="fas fa-wifi"></i> Offline', "var(--danger)");
        renderizar();
      }
    })();
  </script>
</body>
</html>