<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Nossa Jornada | Marcelo & Fernanda</title>

  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
  <link rel="icon" type="image/png" href="/images/icon-192.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: 1px solid rgba(255, 255, 255, 0.15);
      --text-color: #ffffff;
      --accent-pink: #ff758c; --accent-blue: #4facfe;
      --success: #00b09b; --danger: #ff5f6d; --gold: #ffd700;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: 'Poppins', sans-serif; margin: 0; padding: 20px; padding-bottom: 90px;
      color: var(--text-color); min-height: 100vh;
      background: url('images/fundo.jpg') no-repeat center center fixed; background-size: cover; background-attachment: fixed;
    }
    body::before { content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); z-index: -1; }

    .header { text-align: center; margin-bottom: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .header h1 { font-size: 1.8rem; margin: 0; letter-spacing: 1px; }
    .header p { font-size: 0.85rem; opacity: 0.8; font-weight: 300; margin-top: 5px; }

    .btn-agent {
      background: linear-gradient(45deg, #FF9500, #FF5E3A); color: white; border: none; padding: 8px 16px;
      border-radius: 20px; font-weight: bold; font-size: 0.8rem; margin-top: 10px; display: inline-flex;
      align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(255, 94, 58, 0.4); text-decoration: none;
    }

    /* BOT√ÉO DOURADO DO DEVOCIONAL */
    .btn-devocional-topo {
      width: 100%; background: linear-gradient(135deg, #b8860b 0%, #daa520 100%);
      color: #000; font-weight: 800; padding: 15px; border-radius: 15px; margin-bottom: 20px;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 0 15px rgba(218, 165, 32, 0.3); animation: pulseGold 3s infinite;
      border: none; cursor: pointer; font-size: 1rem;
    }
    @keyframes pulseGold { 0% { box-shadow: 0 0 0 0 rgba(218,165,32,0.4); } 70% { box-shadow: 0 0 0 10px rgba(218,165,32,0); } 100% { box-shadow: 0 0 0 0 rgba(218,165,32,0); } }

    /* MODAL SUSPENSO (POP-UP) */
    .modal-dev {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
      background: rgba(0,0,0,0.95); backdrop-filter: blur(8px);
      display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .dev-paper {
      background: #1a1a1a; border: 1px solid var(--gold); border-radius: 15px; width: 100%; max-width: 500px;
      max-height: 85vh; overflow-y: auto; padding: 25px; position: relative; box-shadow: 0 0 30px rgba(255, 215, 0, 0.15);
    }
    .btn-close-dev { position: absolute; top: 10px; right: 15px; background: transparent; border: none; color: #aaa; font-size: 2rem; cursor: pointer; }
    
    .dev-header-modal { text-align: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,215,0,0.2); padding-bottom: 15px; }
    .dev-date { font-family: 'Playfair Display', serif; font-style: italic; color: var(--gold); font-size: 0.9rem; }
    .dev-title { font-family: 'Playfair Display', serif; font-size: 1.6rem; color: white; margin: 5px 0; line-height: 1.2; }
    
    .verse-box { background: rgba(255, 215, 0, 0.05); border-left: 3px solid var(--gold); padding: 15px; margin-bottom: 20px; font-style: italic; font-family: 'Playfair Display', serif; color: #eee; }
    
    .story-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 0.95rem; line-height: 1.6; color: #ddd; text-align: justify; }
    .story-label { font-size: 0.7rem; color: var(--accent-blue); font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }
    
    .ref-box { padding: 5px; font-size: 1rem; line-height: 1.6; color: #fff; text-align: justify; margin-bottom: 20px; }
    .ref-label { font-size: 0.7rem; color: var(--accent-pink); font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }

    .btn-amem { width: 100%; padding: 15px; border-radius: 12px; background: linear-gradient(135deg, #b8860b 0%, #daa520 100%); color: #000; font-weight: 800; border: none; font-size: 1rem; margin-top: 10px; }
    .btn-amem:disabled { background: #333; color: #777; cursor: default; }

    /* ESTILO MISS√ÉO SECRETA */
    .mission-secret-btn {
        width: 100%; padding: 15px; margin-top: 10px; border-radius: 12px; font-size: 0.9rem; font-weight: bold; cursor: pointer; border: 1px dashed rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;
    }
    .btn-marcelo { background: rgba(79, 172, 254, 0.1); color: var(--accent-blue); }
    .btn-fernanda { background: rgba(255, 117, 140, 0.1); color: var(--accent-pink); }
    .btn-marcelo:active, .btn-fernanda:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }

    /* RESTO DO DESIGN */
    .card { background: var(--glass-bg); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
    h3 { margin-top: 0; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }
    .level-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .xp-track { width: 100%; height: 14px; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; }
    .xp-fill { height: 100%; background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 100%); width: 0%; transition: width 1s; }
    
    button { border: none; outline: none; cursor: pointer; font-family: inherit; font-weight: 600; transition: transform 0.2s; }
    button:active { transform: scale(0.96); }
    .btn-main { width: 100%; padding: 14px; border-radius: 12px; background: var(--primary-gradient); color: white; font-size: 1rem; }
    
    .grid-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .action-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 8px; color: white; font-size: 0.9rem; }
    .act-love { border-color: var(--accent-pink); color: var(--accent-pink); }
    .act-peace { border-color: var(--success); color: var(--success); }
    .act-bad { border-color: var(--danger); color: var(--danger); }

    .finance-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .input-glass { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-family: inherit; }
    .input-glass option { background: #333; }
    .btn-deposit { flex: 1; padding: 12px; border-radius: 10px; font-size: 0.9rem; color: #fff; }

    .history-list { max-height: 250px; overflow-y: auto; }
    .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; }
    .badge { padding: 3px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; margin-right: 6px; }
    .bg-marcelo { background: var(--accent-blue); } .bg-fernanda { background: var(--accent-pink); } .bg-nos { background: var(--gold); color:#000; }

    /* TRAVEL TRACKER */
    .travel-track-container { margin-top: 15px; position: relative; padding-top: 20px; }
    .travel-track { width: 100%; height: 10px; background: rgba(255,255,255,0.15); border-radius: 10px; }
    .travel-fill { height: 100%; border-radius: 10px; width: 0%; transition: width 1.5s; position: relative; }
    .travel-icon { position: absolute; right: -12px; top: -24px; font-size: 1.2rem; transition: right 1.5s; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
    .travel-stats { display: flex; justify-content: space-between; font-size: 0.75rem; color: #ccc; margin-top: 6px; }

    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 100; padding: 20px; }
    .modal-box { background: #2d3436; border-radius: 20px; padding: 30px; text-align: center; border: 2px solid var(--accent-pink); max-width: 350px; animation: popUp 0.4s; }
    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .hidden { display: none; }
    .text-gold { color: var(--gold); }
    .text-success { color: var(--success); }
    .status-pill { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; display: inline-flex; align-items: center; gap: 5px; }
  </style>
</head>

<body>
  <div class="header">
    <h1>Marcelo & Fernanda</h1>
    <p>Construindo nosso 2026 üíç</p>
    <a href="https://conselheirocasal.netlify.app/" target="_blank" class="btn-agent" rel="noopener">
      <i class="fas fa-robot"></i> Conselheiro Virtual
    </a>
    <div id="status-conn" style="font-size: 0.7rem; color: var(--accent-blue); margin-top: 10px;">
      <i class="fas fa-circle-notch fa-spin"></i> Conectando...
    </div>
  </div>

  <button class="btn-devocional-topo" onclick="abrirDevocional()">
    <i class="fas fa-book-bible"></i> ALIMENTO DI√ÅRIO
  </button>

  <div id="modal-devocional" class="modal-dev">
    <div class="dev-paper">
      <button class="btn-close-dev" onclick="fecharDevocional()">&times;</button>
      
      <div id="dev-loading" style="text-align:center; padding:30px; color:#aaa;">
          <i class="fas fa-circle-notch fa-spin text-gold"></i> Buscando a Palavra...
      </div>

      <div id="dev-content" class="hidden">
          <div class="dev-header-modal">
             <span id="data-hoje" class="dev-date">--/--</span>
             <h2 id="dev-titulo" class="dev-title">...</h2>
          </div>
          <div class="verse-box">
              <p id="dev-verso">...</p>
          </div>
          <div class="story-box">
              <span class="story-label"><i class="fas fa-book-open"></i> Ilustra√ß√£o</span>
              <span id="dev-historia">...</span>
          </div>
          <div class="ref-box">
              <span class="ref-label"><i class="fas fa-lightbulb"></i> Para o Casal</span>
              <span id="dev-reflexao">...</span>
          </div>
          <button id="btn-amem" class="btn-amem" onclick="lerDevocional()">
             <i class="fas fa-praying-hands"></i> AM√âM! Lemos Juntos (+15 XP)
          </button>
      </div>
    </div>
  </div>

  <div id="modal-premio" class="modal">
    <div class="modal-box">
      <i class="fas fa-trophy fa-3x" style="color: #ffd700; margin-bottom: 15px;"></i>
      <h2 style="color:white; margin-bottom:10px;">N√çVEL NOVO!</h2>
      <p id="premio-txt" style="color:#ccc; margin-bottom:20px; line-height:1.5;">...</p>
      <button class="btn-main" onclick="document.getElementById('modal-premio').style.display='none'">Oba! Vamos nessa!</button>
    </div>
  </div>

  <div class="card" onclick="verProximoPremio()">
    <div class="level-header">
      <h2 id="level-name">Carregando...</h2>
      <span id="xp-total" style="font-weight:bold; color:var(--accent-pink)">0 XP</span>
    </div>
    <div class="xp-track">
      <div class="xp-fill" id="xp-bar"></div>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:0.75rem; color:#aaa;">
      <span>Toque para ver o pr√™mio</span>
      <span>Pr√≥x: <span id="xp-next">100</span></span>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-heart text-gold"></i> Miss√£o Secreta Di√°ria</h3>
    <p style="font-size:0.8rem; opacity:0.8; margin-bottom:15px;">Clique no seu nome para ver. N√£o deixe o outro olhar!</p>
    
    <button class="btn-main" onclick="sortearMissoes()">
      <i class="fas fa-dice"></i> Sortear Novas Miss√µes
    </button>

    <div id="mission-area" class="hidden" style="margin-top: 15px;">
        <button class="mission-secret-btn btn-marcelo" onclick="verMissao('Marcelo')">
            <i class="fas fa-user-secret"></i> üîí Miss√£o do Marcelo
        </button>
        
        <button class="mission-secret-btn btn-fernanda" onclick="verMissao('Fernanda')">
            <i class="fas fa-user-secret"></i> üîí Miss√£o da Fernanda
        </button>

        <div style="display:flex; gap:10px; margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
            <button class="btn-main" style="background:var(--success)" onclick="completarMissao(true)">Cumprimos! (+10)</button>
            <button class="btn-main" style="background:rgba(255,255,255,0.1); border:1px solid #666" onclick="completarMissao(false)">Falhamos</button>
        </div>
    </div>
  </div>

  <div class="grid-actions" style="margin-bottom: 20px;">
    <button class="action-card act-peace" onclick="registrarAcao(5, 'üïäÔ∏è Dia de Paz')">
      <i class="fas fa-hand-holding-heart fa-2x"></i> <span>Dia de Paz</span>
    </button>
    <button class="action-card act-love" onclick="registrarAcao(2, '‚ù§Ô∏è Carinho')">
      <i class="fas fa-kiss-wink-heart fa-2x"></i> <span>Carinho</span>
    </button>
    <button class="action-card act-bad" onclick="registrarAcao(-15, 'üò† Briga')">
      <i class="fas fa-angry fa-2x"></i> <span>Briga</span>
    </button>
    <button class="action-card" onclick="document.getElementById('camera-input').click()">
      <i class="fas fa-camera fa-2x"></i> <span>Foto</span>
    </button>
    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="fotoTirada()" />
  </div>

  <div style="text-align:center; margin-bottom:20px;">
    <a href="https://www.icloud.com/sharedalbum/pt-br/#B1eJtdOXmK81yfe" target="_blank" rel="noopener"
      style="color:#aaa; text-decoration:none; font-size:0.9rem;">
      <i class="fas fa-images"></i> Ver √Ålbum de Fotos
    </a>
  </div>

  <div class="card">
    <h3><i class="fas fa-plane-departure text-gold"></i> Banco de Viagens</h3>
    <p style="font-size:0.8rem; opacity:0.7; margin-bottom:15px;">Foco em Novembro/2026 üöÄ</p>

    <div class="finance-group">
      <select id="user-select" class="input-glass" style="max-width: 110px;">
        <option value="Marcelo">Marcelo</option>
        <option value="Fernanda">Fernanda</option>
        <option value="N√≥s">N√≥s</option>
      </select>
      <input type="text" id="money-input" class="input-glass" placeholder="R$ 0,00" inputmode="decimal" />
    </div>

    <div class="finance-group">
      <button class="btn-deposit" style="background:var(--accent-pink)" onclick="depositar('pe')">Recife/PE</button>
      <button class="btn-deposit" style="background:var(--accent-blue)" onclick="depositar('ch')">Chapada</button>
    </div>

    <div style="margin-top:25px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; color:var(--accent-pink)">Pernambuco ‚òÄÔ∏è</span>
        <span id="status-pe" class="status-pill">üéí Iniciando</span>
      </div>
      <div class="travel-track-container">
        <div class="travel-track">
          <div class="travel-fill" id="bar-pe" style="background:var(--accent-pink);">
             <i class="fas fa-plane travel-icon" style="color:var(--accent-pink)"></i>
          </div>
        </div>
      </div>
      <div class="travel-stats">
        <span id="total-pe">R$ 0,00</span>
        <span>Meta: R$ 7.200</span>
      </div>
    </div>

    <div style="margin-top:25px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; color:var(--accent-blue)">Chapada üèûÔ∏è</span>
        <span id="status-ch" class="status-pill">üéí Iniciando</span>
      </div>
      <div class="travel-track-container">
        <div class="travel-track">
          <div class="travel-fill" id="bar-ch" style="background:var(--accent-blue);">
             <i class="fas fa-car-side travel-icon" style="color:var(--accent-blue)"></i>
          </div>
        </div>
      </div>
      <div class="travel-stats">
        <span id="total-ch">R$ 0,00</span>
        <span>Meta: R$ 2.500</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-bullseye text-gold"></i> Metas 2026</h3>
    <p style="font-size:0.8rem; opacity:0.8; margin-bottom:15px;">O que vamos conquistar individualmente?</p>
    <div class="finance-group">
      <select id="meta-dono" class="input-glass" onchange="renderizarMetas()" style="max-width: 130px;">
        <option value="" disabled selected>Quem √© voc√™?</option>
        <option value="Marcelo">Marcelo</option>
        <option value="Fernanda">Fernanda</option>
      </select>
      <input type="text" id="meta-texto" class="input-glass" placeholder="Escreva uma meta..." />
      <button class="btn-deposit" style="background:var(--success); flex:0 0 50px;" onclick="adicionarMeta()">
        <i class="fas fa-plus"></i>
      </button>
    </div>
    <div id="lista-metas" class="history-list" style="margin-top:10px; max-height: 200px;">
      <div style="text-align:center; padding:15px; color:#aaa; font-size:0.8rem;">Selecione seu nome acima para ver as metas.</div>
    </div>
  </div>

  <div class="card">
    <h3><i class="fas fa-church text-gold"></i> Presen√ßa na Igreja</h3>
    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
      <div>
        <div id="igreja-total" style="font-size:2rem; font-weight:bold;">0</div>
        <div style="font-size:0.8rem; opacity:0.8;">Domingos registrados</div>
      </div>
      <button class="btn-main"
              style="width:auto; padding:10px 16px; background:linear-gradient(135deg,#22c55e,#16a34a);"
              onclick="marcarIgrejaHoje()">
        <i class="fas fa-check-circle"></i> Marcar hoje
      </button>
    </div>
    <div id="igreja-last" style="margin-top:10px; font-size:0.8rem; opacity:0.8;">
      √öltimo registro: ‚Äî
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h3><i class="fas fa-history"></i> Di√°rio</h3>
      <i class="fas fa-trash" style="color:#666; cursor:pointer;" onclick="limparTudo()" title="Resetar Tudo"></i>
    </div>
    <div id="history-list" class="history-list">
      <div style="text-align:center; padding:20px; color:#aaa;">Carregando hist√≥ria...</div>
    </div>
  </div>

  <script type="module">
    // 1. Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => { navigator.serviceWorker.register("/sw.js").catch(() => {}); });
    }

    const statusEl = document.getElementById("status-conn");
    function setStatus(html, cssColor) { statusEl.innerHTML = html; statusEl.style.color = cssColor; }
    window.addEventListener("offline", () => setStatus('<i class="fas fa-wifi"></i> Offline', "var(--danger)"));
    window.addEventListener("online", () => setStatus('<i class="fas fa-circle-notch fa-spin"></i> Reconectando...', "var(--accent-blue)"));

    // 2. Importa√ß√£o Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // 3. Config e Estado
    const firebaseConfig = {
      apiKey: "AIzaSyC8YA9o9KVlKW1j9Ps2gqwYYWJDnFt6Go4",
      authDomain: "casal2026-888ce.firebaseapp.com",
      databaseURL: "https://casal2026-888ce-default-rtdb.firebaseio.com",
      projectId: "casal2026-888ce",
      storageBucket: "casal2026-888ce.firebasestorage.app",
      messagingSenderId: "314398386836",
      appId: "1:314398386836:web:e401b22d85e7bbe5e9e281",
      measurementId: "G-RHXB26B178"
    };

    const fmtBRL = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });
    let estado = { xp: 0, pe: 0, ch: 0, list: [], igrejaCount: 0, igrejaLast: null, metas: {}, missaoM: "", missaoF: "" };
    const ALVO_PE = 7200; const ALVO_CH = 2500;

    const niveis = [
      {id:1, max:150, nome:"In√≠cio", premio:"Piquenique na Ermida Dom Bosco"},
      {id:2, max:400, nome:"Aprendizes", premio:"Caminhada no Pont√£o + √Ågua de Coco"},
      {id:3, max:800, nome:"Parceiros", premio:"Eix√£o do Lazer + Fotos na SQS 308"},
      {id:4, max:1300, nome:"C√∫mplices", premio:"CCBB Cultural + Passeio no Jardim"},
      {id:5, max:1900, nome:"Namorados", premio:"Pastel na Torre de TV"},
      {id:6, max:2600, nome:"Noivos", premio:"Cine Drive-in (Noite Retr√¥)"},
      {id:7, max:3500, nome:"Guardi√µes", premio:"Trilha na √Ågua Mineral"},
      {id:8, max:4500, nome:"Guerreiros", premio:"Visita ao Templo da LBV (Paz)"},
      {id:9, max:6000, nome:"Inabal√°veis", premio:"Jardim Bot√¢nico (Piquenique)"},
      {id:10, max:7500, nome:"Alma G√™mea", premio:"Torre Digital (Vista do DF)"},
      {id:11, max:9500, nome:"Realeza", premio:"Jantar de Gala em Casa"},
      {id:12, max:13000, nome:"Lend√°rios", premio:"VIAGEM PARA PERNAMBUCO!"}
    ];

    const missoes = [
      "D√™ um abra√ßo de urso de 1 minuto em sil√™ncio agora.",
      "D√™ um beijo de 10 segundos (conte mentalmente!) ao se encontrarem.",
      "Sirva um copo de √°gua ou caf√© para o outro sem ele pedir.",
      "Elogie uma roupa ou o perfume que o outro est√° usando.",
      "Fa√ßa uma ora√ß√£o de 1 minuto de m√£os dadas agradecendo pelo dia.",
      "Envie um WhatsApp agora dizendo: 'Sou feliz com voc√™'.",
      "Fa√ßa cafun√© ou mexa no cabelo do outro por 3 minutos.",
      "Fa√ßa uma massagem r√°pida (5 min) nos ombros ou p√©s do outro.",
      "Arrume a cama (ou ajude a terminar de arrumar) caprichado.",
      "Elogie uma qualidade de car√°ter do outro (ex: paci√™ncia, esfor√ßo).",
      "Pergunte 'Qual foi a melhor parte do seu dia?' e ou√ßa com aten√ß√£o.",
      "Deixem os celulares em outro c√¥modo por 20 minutos juntos.",
      "Agrade√ßa por algo simples que o outro fez essa semana.",
      "Lave a lou√ßa do jantar ou tire o lixo para aliviar o outro.",
      "Coloque uma m√∫sica rom√¢ntica e tirem o outro para dan√ßar na sala.",
      "Leia um vers√≠culo de Salmos (ex: Sl 23) em voz alta para o outro.",
      "D√™ tr√™s beijos na testa do outro em momentos diferentes hoje.",
      "Prepare um lanche surpresa ou leve uma fruta para o outro.",
      "Tirem uma selfie fazendo careta e guardem s√≥ para voc√™s.",
      "Conte uma piada ruim ou mostre um v√≠deo engra√ßado para o outro rir.",
      "Conversem 5 minutos sobre um sonho para a viagem de 2026.",
      "Olhe nos olhos por 30 segundos e termine dizendo 'Eu te amo'.",
      "Assista a um v√≠deo ou programa de TV de m√£os dadas.",
      "J√° deixou a pasta de dente pronta na escova do outro? Fa√ßa hoje.",
      "Fa√ßa uma ora√ß√£o aben√ßoando o trabalho/estudos do outro.",
      "Relembrem em 2 minutos como foi o primeiro encontro de voc√™s.",
      "Invente um apelido fofo novo e use-o durante o dia.",
      "Pergunte agora: 'Posso te ajudar em algo r√°pido?'.",
      "Ou√ßam um louvor juntos antes de dormir.",
      "Fa√ßa um voto de sil√™ncio sobre reclama√ß√µes hoje (s√≥ elogie).",
      "Receba o outro com um sorriso enorme assim que o vir.",
      "Mande uma foto sua agora para o outro ver onde voc√™ est√°.",
      "Deixe o outro escolher o que v√£o assistir ou ouvir hoje.",
      "Fa√ßam um brinde (com √°gua ou suco) √† sa√∫de de voc√™s.",
      "Organize os sapatos ou chinelos do outro que estiverem jogados.",
      "D√™ um beijo de 'Bom Dia' ou 'Boa Noite' digno de filme.",
      "Agrade√ßa a Deus em voz alta: 'Obrigado pela vida do(a)...'.",
      "Elogie seu c√¥njuge na frente de outra pessoa (ou no grupo da fam√≠lia).",
      "Limpe algo que o outro sujou sem reclamar.",
      "Fiquem deitados abra√ßados por 5 minutos sem falar de problemas.",
      "Escreva um bilhete 'Te Amo' e cole no espelho ou geladeira.",
      "Pergunte: 'O que eu posso fazer para voc√™ ficar mais feliz hoje?'.",
      "Sirva o prato do outro no almo√ßo ou jantar.",
      "Fa√ßa carinho nas costas enquanto o outro faz alguma tarefa.",
      "Diga 'Obrigado por ser meu parceiro(a)' olhando nos olhos.",
      "Leiam juntos o Salmo 121 antes de apagar a luz.",
      "Afofe o travesseiro do outro antes de deitar.",
      "Desligue a luz ou feche a porta para o outro.",
      "Pergunte sobre uma preocupa√ß√£o do outro e diga 'Vai dar certo'.",
      "Fa√ßa um convite oficial para um 'encontro no sof√°' hoje √† noite."
    ];

    let db, dbRef, igrejaRef, metasRef;
    let firebaseReady = false;

    // 4. Fun√ß√µes Globais
    window.abrirDevocional = () => { document.getElementById("modal-devocional").style.display = "flex"; carregarDevocional(); };
    window.fecharDevocional = () => { document.getElementById("modal-devocional").style.display = "none"; };

    window.lerDevocional = () => {
        if(!firebaseReady) return;
        const h = new Date();
        const k = `lido-${h.getMonth()+1}-${h.getDate()}-${h.getFullYear()}`;
        
        const btn = document.getElementById("btn-amem");
        if(btn.disabled) return;

        push(dbRef, { date: new Date().toLocaleDateString(), user: "N√≥s", desc: "Devocional lido üìñ", xp: 15, val: 0, tipo: "devocional" });
        localStorage.setItem(k, "true");
        btn.innerHTML = '<i class="fas fa-check"></i> AM√âM! LIDO';
        btn.disabled = true;
        btn.style.background = "#333";
        setTimeout(() => { window.fecharDevocional(); }, 1500);
    };

    window.renderizarMetas = () => {
        const dono = document.getElementById("meta-dono").value;
        const lista = document.getElementById("lista-metas");
        if(!lista) return;
        lista.innerHTML = "";
        const m = estado.metas[dono] || {};
        if(!dono) { lista.innerHTML = `<div style="text-align:center; padding:15px; opacity:0.6;">Selecione seu nome.</div>`; return; }
        Object.keys(m).forEach(k => {
            lista.innerHTML += `<div class="history-item"><div style="flex:1">${m[k].texto}</div><i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="apagarMeta('${dono}','${k}')"></i></div>`;
        });
    };

    window.adicionarMeta = () => {
        if(!firebaseReady) return;
        const d = document.getElementById("meta-dono").value;
        const t = document.getElementById("meta-texto").value;
        if(d && t) { push(ref(db, `metas/${d}`), { texto: t, criadoEm: new Date().toLocaleDateString() }); document.getElementById("meta-texto").value=""; }
    };
    window.apagarMeta = (d,i) => { if(confirm("Apagar?")) remove(ref(db, `metas/${d}/${i}`)); };

    window.verProximoPremio = () => {
        const n = getNivel();
        document.getElementById("premio-txt").innerText = n.premio;
        document.getElementById("modal-premio").style.display = "flex";
    };

    // NOVA L√ìGICA DE MISS√ïES SECRETAS
    window.sortearMissoes = () => {
        estado.missaoM = missoes[Math.floor(Math.random()*missoes.length)];
        estado.missaoF = missoes[Math.floor(Math.random()*missoes.length)];
        document.getElementById("mission-area").classList.remove("hidden");
        alert("Miss√µes Sorteada! Agora clique no seu nome para ver a sua em segredo.");
    };

    window.verMissao = (quem) => {
        const txt = quem === 'Marcelo' ? estado.missaoM : estado.missaoF;
        if(!txt) return alert("Sorteie primeiro!");
        alert(`üïµÔ∏è MISS√ÉO SECRETA DE ${quem.toUpperCase()}:\n\n"${txt}"\n\n(N√£o conte para o outro at√© cumprir!)`);
    };

    window.completarMissao = (ok) => {
        if(ok) registrarAcao(10, "Miss√£o Cumprida!"); else registrarAcao(-5, "Miss√£o Falhou");
        document.getElementById("mission-area").classList.add("hidden");
    };

    window.fotoTirada = () => alert("Foto tirada! Salve no √Ålbum.");
    window.registrarAcao = (xp, desc) => { if(firebaseReady) push(dbRef, { date: new Date().toLocaleDateString(), user:document.getElementById("user-select").value||"N√≥s", desc, xp, val:0 }); };
    
    window.depositar = (tipo) => {
        if(!firebaseReady) return;
        const val = parseFloat(document.getElementById("money-input").value.replace(",","."));
        if(!val) return alert("Valor?");
        push(dbRef, { date: new Date().toLocaleDateString(), user:document.getElementById("user-select").value||"N√≥s", desc:`Poupan√ßa ${tipo.toUpperCase()}`, xp:5, val, tipo });
        document.getElementById("money-input").value="";
        alert("Guardado!");
    };
    
    window.remover = (id) => { if(confirm("Apagar?")) remove(ref(db, `historico/${id}`)); };
    window.limparTudo = () => { if(confirm("Resetar TUDO?")) remove(dbRef); };
    
    window.marcarIgrejaHoje = () => {
        if(!firebaseReady) return;
        const d = new Date().toLocaleDateString();
        if(estado.igrejaLast && estado.igrejaLast.date===d) { if(!confirm("J√° marcou. De novo?")) return; }
        push(igrejaRef, { date:d, dateISO:new Date().toISOString() });
        push(dbRef, { date:d, user:"N√≥s", desc:"Igreja üôè", xp:20, val:0 });
        alert("Am√©m!");
    };

    function carregarDevocional() {
        if (!db) return;
        const h = new Date();
        const k = `${String(h.getMonth()+1).padStart(2,'0')}-${String(h.getDate()).padStart(2,'0')}`;
        
        const m = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
        document.getElementById("data-hoje").innerText = `${h.getDate()} de ${m[h.getMonth()]}`;

        onValue(ref(db, `devocionais/${k}`), (snap) => {
            const d = snap.val();
            document.getElementById("dev-loading").classList.add("hidden");
            document.getElementById("dev-content").classList.remove("hidden");
            
            if (d) {
               document.getElementById("dev-titulo").innerText = d.titulo;
               document.getElementById("dev-verso").innerText = d.verso;
               if(d.historia) {
                   document.getElementById("dev-historia").innerText = d.historia;
                   document.getElementById("dev-historia").parentElement.classList.remove("hidden");
               } else { document.getElementById("dev-historia").parentElement.classList.add("hidden"); }
               document.getElementById("dev-reflexao").innerText = d.reflexao || d.texto || "...";
            } else {
               document.getElementById("dev-titulo").innerText = "Aguardando...";
               document.getElementById("dev-verso").innerText = "Salmos 1:1";
               document.getElementById("dev-reflexao").innerText = "Sem devocional cadastrado hoje.";
               document.getElementById("dev-historia").parentElement.classList.add("hidden");
            }

            const lk = `lido-${k}-${h.getFullYear()}`;
            const btn = document.getElementById("btn-amem");
            if(localStorage.getItem(lk)) {
                 btn.innerHTML = '<i class="fas fa-check"></i> AM√âM! LIDO';
                 btn.disabled = true; btn.style.opacity = "0.5"; btn.style.background = "#333";
            } else {
                 btn.innerHTML = '<i class="fas fa-praying-hands"></i> AM√âM! Lemos Juntos (+15 XP)';
                 btn.disabled = false; btn.style.opacity = "1"; btn.style.background = "linear-gradient(135deg, #b8860b 0%, #daa520 100%)";
            }
        });
    }

    // Fun√ß√£o auxiliar para calcular n√≠vel e renderizar
    function getNivel() {
      let atual = niveis[0];
      for (let n of niveis) { if (estado.xp < n.max) { atual = n; break; } if (n.id === 12) atual = n; }
      return atual;
    }
    
    function getTravelStatus(val, max) { 
        const p = (val/max)*100; 
        if(p<=0)return "üéí Iniciando"; if(p<20)return "üß≥ Arrumando"; 
        if(p<50)return "üöó A Caminho"; if(p<80)return "‚úàÔ∏è Quase l√°"; 
        if(p<100)return "üèñÔ∏è Vendo o Mar"; return "ü•Ç CONQUISTADO!"; 
    }

    // Inicializa√ß√£o
    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        dbRef = ref(db, "historico");
        igrejaRef = ref(db, "igreja");
        metasRef = ref(db, "metas");
        firebaseReady = true;
        setStatus('<i class="fas fa-wifi"></i> Online', "var(--success)");

        onValue(dbRef, (snap) => {
            const data = snap.val();
            estado.list = [];
            if (data) Object.keys(data).forEach(k => estado.list.push({ id: k, ...data[k] }));
            
            estado.xp=0; estado.pe=0; estado.ch=0;
            estado.list.forEach(i => {
                estado.xp += Number(i.xp || 0);
                if (i.tipo === "pe") estado.pe += Number(i.val || 0);
                if (i.tipo === "ch") estado.ch += Number(i.val || 0);
            });

            const n = getNivel();
            document.getElementById("level-name").innerText = n.nome;
            document.getElementById("xp-total").innerText = `${estado.xp} XP`;
            document.getElementById("xp-next").innerText = n.max;
            document.getElementById("xp-bar").style.width = `${Math.min((estado.xp/n.max)*100,100)}%`;

            document.getElementById("total-pe").innerText = fmtBRL.format(estado.pe);
            document.getElementById("bar-pe").style.width = `${Math.min((estado.pe/ALVO_PE)*100,100)}%`;
            document.getElementById("status-pe").innerText = getTravelStatus(estado.pe, ALVO_PE);

            document.getElementById("total-ch").innerText = fmtBRL.format(estado.ch);
            document.getElementById("bar-ch").style.width = `${Math.min((estado.ch/ALVO_CH)*100,100)}%`;
            document.getElementById("status-ch").innerText = getTravelStatus(estado.ch, ALVO_CH);

            const l = document.getElementById("history-list");
            l.innerHTML = "";
            if(!estado.list.length) l.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa;">Sem registros.</div>`;
            else [...estado.list].reverse().forEach(i => {
                const who = i.user || "N√≥s";
                const cls = who === "Marcelo"?"bg-marcelo":(who==="Fernanda"?"bg-fernanda":"bg-nos");
                const c = i.xp>0?"var(--success)":(i.xp<0?"var(--danger)":"#aaa");
                l.innerHTML += `
                  <div class="history-item">
                    <div>
                      <div><span class="badge ${cls}">${who}</span> <span style="opacity:0.6; font-size:0.7rem">${i.date||""}</span></div>
                      <div style="margin-top:4px;">${i.desc||""} ${i.val>0 ? `(${fmtBRL.format(i.val)})` : ""}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                      <span style="color:${c}; font-weight:bold;">${i.xp>0?"+":""}${i.xp}</span>
                      <i class="fas fa-times" style="opacity:0.3; cursor:pointer;" onclick="remover('${i.id}')"></i>
                    </div>
                  </div>`;
            });
        });

        onValue(igrejaRef, (snap) => {
            const data = snap.val();
            let count = 0, last = null;
            if (data) {
                Object.keys(data).forEach(k => {
                    const i = data[k]; count++;
                    if (!last || new Date(i.dateISO||i.date) > new Date(last?.dateISO||last?.date||0)) last = i;
                });
            }
            estado.igrejaCount = count; estado.igrejaLast = last;
            document.getElementById("igreja-total").innerText = count;
            document.getElementById("igreja-last").innerText = last ? `√öltimo registro: ${last.date}` : "√öltimo registro: ‚Äî";
        });

        onValue(metasRef, (snap) => {
            estado.metas = snap.val() || {};
            renderizarMetas();
        });

        carregarDevocional();

    } catch (err) {
        console.error(err);
        setStatus('<i class="fas fa-exclamation-triangle"></i> Erro', "var(--danger)");
    }
  </script>
</body>
</html>